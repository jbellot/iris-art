---
phase: 01-foundation-and-privacy-architecture
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - backend/app/services/privacy.py
  - backend/app/services/user.py
  - backend/app/schemas/privacy.py
  - backend/app/api/routes/privacy.py
  - backend/app/api/routes/users.py
  - backend/app/workers/tasks/exports.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "App returns jurisdiction-specific consent requirements based on user IP (GDPR for EU, BIPA for Illinois, CCPA for California)"
    - "User can grant biometric consent with full audit trail (timestamp, IP, jurisdiction, consent text version)"
    - "User can withdraw previously granted consent"
    - "User can request a data export containing all their personal data in JSON+ZIP format"
    - "User can delete their account and ALL associated data is removed from database, S3, and Redis"
    - "Consent must be recorded BEFORE any biometric data can be collected (enforced by API)"
  artifacts:
    - path: "backend/app/services/privacy.py"
      provides: "Jurisdiction detection, consent management, consent requirements"
      contains: "detect_jurisdiction"
    - path: "backend/app/services/user.py"
      provides: "Account deletion with full data erasure across all systems"
      contains: "delete_user_account"
    - path: "backend/app/schemas/privacy.py"
      provides: "Privacy/consent Pydantic schemas"
      contains: "ConsentGrantRequest"
    - path: "backend/app/api/routes/privacy.py"
      provides: "Privacy API endpoints (consent, data export, jurisdiction)"
      contains: "router"
    - path: "backend/app/workers/tasks/exports.py"
      provides: "Celery task for generating GDPR data export"
      contains: "export_user_data"
  key_links:
    - from: "backend/app/api/routes/privacy.py"
      to: "backend/app/services/privacy.py"
      via: "Service layer for consent and jurisdiction"
      pattern: "privacy_service|detect_jurisdiction|grant_consent"
    - from: "backend/app/services/user.py"
      to: "backend/app/storage/s3.py"
      via: "Delete user files from S3"
      pattern: "delete_user_files"
    - from: "backend/app/services/user.py"
      to: "backend/app/core/security.py"
      via: "Revoke all user tokens from Redis"
      pattern: "revoke_all_user_tokens"
    - from: "backend/app/api/routes/users.py"
      to: "backend/app/services/user.py"
      via: "Account deletion endpoint"
      pattern: "delete_user_account"
    - from: "backend/app/workers/tasks/exports.py"
      to: "backend/app/storage/s3.py"
      via: "Upload export ZIP to S3, generate presigned URL"
      pattern: "upload_file|generate_presigned_url"
---

<objective>
Implement privacy compliance: jurisdiction-aware consent flows (GDPR/BIPA/CCPA), biometric consent recording with audit trail, consent withdrawal, GDPR data export, and complete account deletion with data erasure across all systems (database, S3, Redis).

Purpose: Privacy compliance is a legal prerequisite for iris capture (Phase 2+). BIPA violations carry statutory damages of up to $5,000 per violation. Consent must be obtained BEFORE any biometric data collection. Account deletion (GDPR Article 17) must be complete across all storage systems.

Output: Privacy API endpoints where users can get jurisdiction-specific consent requirements, grant/withdraw consent, request data exports, and delete their accounts with full data erasure. All consent operations have immutable audit trails.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-privacy-architecture/01-RESEARCH.md
@.planning/phases/01-foundation-and-privacy-architecture/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-privacy-architecture/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Privacy service, consent management, and jurisdiction detection</name>
  <files>
    backend/app/services/privacy.py
    backend/app/schemas/privacy.py
    backend/app/workers/tasks/exports.py
    backend/app/services/user.py
  </files>
  <action>
    **backend/app/schemas/privacy.py:** Privacy Pydantic schemas:
    - JurisdictionResponse(jurisdiction: str, consent_requirements: dict) -- returned by jurisdiction detection
    - ConsentRequirements with fields: explicit_consent (bool), purpose_disclosure (bool), retention_policy (bool), right_to_withdraw (bool), consent_text (str), additional jurisdiction-specific fields
    - ConsentGrantRequest(consent_type: str, jurisdiction: str, consent_text_version: str) -- consent_type enum: "biometric_capture", "data_processing"
    - ConsentGrantResponse(id: UUID, consent_type: str, jurisdiction: str, granted: bool, granted_at: datetime)
    - ConsentWithdrawRequest(consent_id: UUID)
    - ConsentListResponse(consents: list[ConsentGrantResponse])
    - DataExportResponse(message: str, export_url: str | None = None, status: str) -- status: "pending", "ready", "expired"
    - AccountDeletionResponse(message: str, deleted_at: datetime)

    **backend/app/services/privacy.py:** Privacy business logic:

    1. **Jurisdiction Detection:**
    - `detect_jurisdiction(ip_address: str) -> Jurisdiction` -- uses IP to determine jurisdiction
    - For development/MVP: implement a simplified version that uses IP geolocation. Since GeoIP database is an open question from research, implement a lightweight approach:
      * Use a simple mapping approach: check if IP is from known EU ranges OR use a free IP geolocation API (ip-api.com for dev, rate-limited)
      * For production readiness, abstract behind a JurisdictionDetector interface so GeoIP2/MaxMind can be swapped in later
      * Default to Jurisdiction.GENERIC if detection fails
    - Jurisdiction enum: GDPR, BIPA, CCPA, GENERIC (same as research)
    - Also accept optional `country_code` and `state_code` parameters that the mobile app can pass from device locale (more reliable than IP)

    2. **Consent Requirements:**
    - `get_consent_requirements(jurisdiction: Jurisdiction) -> dict` -- returns jurisdiction-specific consent text and requirements (follow the exact patterns from 01-RESEARCH.md Pattern 5)
    - GDPR: explicit_consent, purpose_disclosure, retention_policy, right_to_withdraw, data_minimization
    - BIPA: written_consent (electronic signature valid), purpose_disclosure, retention_schedule, no_profit_from_data
    - CCPA: notice_at_collection, opt_out_right, deletion_right
    - GENERIC: basic_consent

    3. **Consent Management:**
    - `grant_consent(db, user_id, consent_type, jurisdiction, ip_address, consent_text_version) -> ConsentRecord` -- creates ConsentRecord with all audit fields (timestamp, IP, jurisdiction, text version). Validate that consent_type is valid enum value.
    - `withdraw_consent(db, user_id, consent_id) -> ConsentRecord` -- sets withdrawn_at timestamp on existing record. Does NOT delete the record (audit trail must be preserved). Raises 404 if consent not found or not owned by user.
    - `get_user_consents(db, user_id) -> list[ConsentRecord]` -- returns all consent records for user
    - `has_biometric_consent(db, user_id) -> bool` -- checks if user has active (granted=True, withdrawn_at=None) biometric_capture consent. This will be used as a gate in Phase 2 before any iris capture.

    **backend/app/services/user.py:** User account management:
    - `delete_user_account(db, user_id, s3_client) -> None` -- GDPR Article 17 complete erasure:
      1. Delete all S3 objects for user (iris images, generated art, exports) via s3.delete_user_files(bucket, f"iris/{user_id}/")
      2. Revoke all refresh tokens from Redis via security.revoke_all_user_tokens(user_id)
      3. Delete all ConsentRecords for user from database
      4. Delete User record from database
      5. Commit transaction
      6. Log deletion for compliance audit trail (log user_id, timestamp, NOT personal data)
    - `export_user_data(db, user_id, s3_client) -> str` -- generates JSON manifest of all user data:
      1. Fetch user profile (email, created_at, etc.)
      2. Fetch all consent records
      3. List all S3 objects for user, generate presigned URLs (1 hour expiry)
      4. Bundle into JSON structure
      5. Create ZIP file with JSON manifest + optionally download images
      6. Upload ZIP to S3 export path
      7. Return presigned URL to download the ZIP
      This is complex, so also create a Celery task wrapper.

    **backend/app/workers/tasks/exports.py:** Celery tasks:
    - `export_user_data_task(user_id: str)` -- Celery task that calls user.export_user_data with its own DB session. Stores result URL in Redis with 24-hour TTL key `export:{user_id}`.

    AVOID:
    - Do NOT delete ConsentRecords on consent withdrawal (only set withdrawn_at -- audit trail is legally required)
    - Do NOT capture biometric data before consent is granted (has_biometric_consent is the gate)
    - Do NOT use one-size-fits-all consent text (must be jurisdiction-specific)
    - Do NOT log personal data in deletion audit trail (only log user_id and timestamp)
    - Do NOT block the API on export generation (use Celery task)
  </action>
  <verify>
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && docker compose exec web python -c "from app.services.privacy import detect_jurisdiction, get_consent_requirements, Jurisdiction; print(get_consent_requirements(Jurisdiction.GDPR)['consent_text'][:50])"` should print GDPR consent text.
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && docker compose exec web python -c "from app.services.user import delete_user_account, export_user_data; print('User service OK')"` should succeed.
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && docker compose exec web python -c "from app.schemas.privacy import ConsentGrantRequest, JurisdictionResponse; print('Privacy schemas OK')"` should succeed.
  </verify>
  <done>
    Jurisdiction detection returns correct jurisdiction based on IP/locale. Consent requirements are jurisdiction-specific (GDPR/BIPA/CCPA/GENERIC). Consent can be granted with full audit trail and withdrawn without deleting records. Account deletion removes data from DB, S3, and Redis. Data export generates downloadable ZIP via Celery task.
  </done>
</task>

<task type="auto">
  <name>Task 2: Privacy API routes, account deletion endpoint, and integration testing</name>
  <files>
    backend/app/api/routes/privacy.py
    backend/app/api/routes/users.py
    backend/app/main.py
  </files>
  <action>
    **backend/app/api/routes/privacy.py:** Privacy API router (prefix="/api/v1/privacy"):
    - GET /jurisdiction -- detects jurisdiction from request IP (use request.client.host), optionally accepts ?country_code=FR&state_code= query params. Returns JurisdictionResponse with jurisdiction and consent requirements.
    - GET /consent -- requires auth, returns ConsentListResponse with all user's consent records
    - POST /consent -- requires auth, accepts ConsentGrantRequest, records consent with audit trail (IP from request, timestamp from server), returns ConsentGrantResponse with 201
    - POST /consent/{consent_id}/withdraw -- requires auth, withdraws consent (sets withdrawn_at), returns updated ConsentGrantResponse
    - GET /consent/biometric-status -- requires auth, returns {"has_consent": bool} -- quick check used by mobile app before camera
    - POST /data-export -- requires auth, dispatches Celery export task, returns DataExportResponse with status="pending"
    - GET /data-export/status -- requires auth, checks Redis for export result, returns DataExportResponse with presigned URL if ready

    **backend/app/api/routes/users.py:** Add account deletion:
    - DELETE /api/v1/users/me -- requires auth, calls delete_user_account, returns AccountDeletionResponse with 200. Requires user to confirm by passing {"confirm": true} in body (safety check against accidental deletion).

    **backend/app/main.py:** Update to include privacy router.

    After creating routes, run integration tests:
    1. Start stack: `docker compose up -d`
    2. Register and login to get tokens (reuse from Plan 02 or create new user)
    3. Test jurisdiction detection: `curl http://localhost:8000/api/v1/privacy/jurisdiction` -- should return jurisdiction and requirements
    4. Test jurisdiction with params: `curl "http://localhost:8000/api/v1/privacy/jurisdiction?country_code=DE"` -- should return GDPR
    5. Test grant consent: `curl -X POST http://localhost:8000/api/v1/privacy/consent -H "Authorization: Bearer {token}" -H "Content-Type: application/json" -d '{"consent_type":"biometric_capture","jurisdiction":"gdpr","consent_text_version":"v1.0"}'` -- should return 201
    6. Test list consents: `curl http://localhost:8000/api/v1/privacy/consent -H "Authorization: Bearer {token}"` -- should return list with the granted consent
    7. Test biometric status: `curl http://localhost:8000/api/v1/privacy/consent/biometric-status -H "Authorization: Bearer {token}"` -- should return {"has_consent": true}
    8. Test withdraw consent: `curl -X POST http://localhost:8000/api/v1/privacy/consent/{consent_id}/withdraw -H "Authorization: Bearer {token}"` -- should return updated consent with withdrawn_at
    9. Test biometric status after withdrawal: should return {"has_consent": false}
    10. Test data export: `curl -X POST http://localhost:8000/api/v1/privacy/data-export -H "Authorization: Bearer {token}"` -- should return status="pending"
    11. Check export status: `curl http://localhost:8000/api/v1/privacy/data-export/status -H "Authorization: Bearer {token}"` -- should eventually return URL
    12. Test account deletion: First register a new throwaway user, login, then: `curl -X DELETE http://localhost:8000/api/v1/users/me -H "Authorization: Bearer {token}" -H "Content-Type: application/json" -d '{"confirm":true}'` -- should return 200
    13. Verify deleted user can't login: `curl -X POST http://localhost:8000/api/v1/auth/login -H "Content-Type: application/json" -d '{"email":"deleted@example.com","password":"Test1234"}'` -- should return 401
    14. Verify the OpenAPI docs show all privacy endpoints: `curl http://localhost:8000/docs`

    AVOID:
    - Do NOT allow account deletion without {"confirm": true} body
    - Do NOT return 404 on password reset for unknown emails (prevents email enumeration -- already handled in Plan 02 but verify no regression)
    - Do NOT allow granting consent without authentication
  </action>
  <verify>
    Run full integration sequence via curl:
    - GET /jurisdiction returns jurisdiction with consent requirements
    - POST /consent creates consent record (201)
    - GET /consent lists user consents
    - GET /consent/biometric-status returns {"has_consent": true}
    - POST /consent/{id}/withdraw sets withdrawn_at
    - POST /data-export returns status="pending"
    - DELETE /users/me with {"confirm": true} deletes account
    - Deleted user cannot login (401)
    Run: `curl http://localhost:8000/docs` shows privacy and user endpoints.
  </verify>
  <done>
    All privacy endpoints work: jurisdiction detection returns correct requirements per jurisdiction, consent granting creates audit-trailed records, consent withdrawal preserves records while marking withdrawn, biometric consent status gate works, data export dispatches to Celery, account deletion removes all user data from DB/S3/Redis. Deleted users cannot authenticate. OpenAPI docs show complete API.
  </done>
</task>

</tasks>

<verification>
1. GET /api/v1/privacy/jurisdiction returns jurisdiction and consent requirements
2. GET /api/v1/privacy/jurisdiction?country_code=DE returns GDPR jurisdiction
3. GET /api/v1/privacy/jurisdiction?country_code=US&state_code=IL returns BIPA jurisdiction
4. POST /api/v1/privacy/consent creates consent with audit trail (201)
5. GET /api/v1/privacy/consent/biometric-status returns {"has_consent": true} after granting
6. POST /api/v1/privacy/consent/{id}/withdraw marks consent as withdrawn (not deleted)
7. GET /api/v1/privacy/consent/biometric-status returns {"has_consent": false} after withdrawal
8. POST /api/v1/privacy/data-export dispatches export task
9. DELETE /api/v1/users/me with confirm=true removes all user data
10. Deleted user cannot authenticate (401)
11. Consent records have immutable audit trail (timestamp, IP, jurisdiction, text version)
</verification>

<success_criteria>
- Jurisdiction detection works for GDPR (EU countries), BIPA (Illinois), CCPA (California), and GENERIC
- Consent text is jurisdiction-specific (different text for GDPR vs BIPA vs CCPA)
- Consent records include full audit trail (timestamp, IP, jurisdiction, consent text version)
- Consent withdrawal preserves the original record (sets withdrawn_at, does not delete)
- Biometric consent status endpoint provides gate for future iris capture
- Data export generates downloadable ZIP with user data via Celery
- Account deletion removes data from PostgreSQL, S3, and Redis completely
- All privacy endpoints require authentication
- No personal data logged in deletion audit trail
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-privacy-architecture/01-03-SUMMARY.md`
</output>

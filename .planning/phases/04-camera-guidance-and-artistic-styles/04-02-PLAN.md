---
phase: 04-camera-guidance-and-artistic-styles
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/style_preset.py
  - backend/app/models/style_job.py
  - backend/app/schemas/styles.py
  - backend/app/services/styles.py
  - backend/app/workers/models/style_transfer_model.py
  - backend/app/workers/models/model_cache.py
  - backend/app/workers/tasks/style_transfer.py
  - backend/app/api/routes/styles.py
  - backend/app/main.py
  - backend/requirements.txt
  - mobile/src/types/styles.ts
  - mobile/src/services/styles.ts
  - mobile/src/hooks/useStyleTransfer.ts
  - mobile/src/store/styleStore.ts
  - mobile/src/components/Styles/StyleThumbnail.tsx
  - mobile/src/components/Styles/StyleGrid.tsx
  - mobile/src/components/Styles/ProgressiveImage.tsx
  - mobile/src/screens/Styles/StyleGalleryScreen.tsx
  - mobile/src/screens/Styles/StylePreviewScreen.tsx
  - mobile/src/navigation/types.ts
  - mobile/src/navigation/RootNavigator.tsx
autonomous: true

must_haves:
  truths:
    - "User can browse a gallery of 5-10 free and 10-15 premium style presets with thumbnail previews"
    - "User can tap a free style preset and see it applied to their processed iris art"
    - "User can see premium style previews but they are visually marked as locked/premium"
    - "User sees a low-res styled preview quickly while HD version generates in background"
    - "Style transfer runs as a Celery background job with WebSocket progress updates"
  artifacts:
    - path: "backend/app/models/style_preset.py"
      provides: "StylePreset model with name, type (free/premium), thumbnail_s3_key"
      contains: "class StylePreset"
    - path: "backend/app/models/style_job.py"
      provides: "StyleJob model tracking style application requests"
      contains: "class StyleJob"
    - path: "backend/app/workers/tasks/style_transfer.py"
      provides: "Celery task applying Fast NST to iris images"
      contains: "apply_style_preset"
    - path: "backend/app/api/routes/styles.py"
      provides: "REST API for listing styles and submitting style jobs"
      exports: ["router"]
    - path: "mobile/src/screens/Styles/StyleGalleryScreen.tsx"
      provides: "Style browsing screen with free and premium sections"
    - path: "mobile/src/screens/Styles/StylePreviewScreen.tsx"
      provides: "Before/after preview with styled result and progressive loading"
  key_links:
    - from: "mobile/src/services/styles.ts"
      to: "backend/app/api/routes/styles.py"
      via: "REST API calls for list presets and submit style job"
      pattern: "api/v1/styles"
    - from: "backend/app/workers/tasks/style_transfer.py"
      to: "backend/app/workers/models/style_transfer_model.py"
      via: "Celery task loads and runs style model"
      pattern: "StyleTransferModel"
    - from: "mobile/src/hooks/useStyleTransfer.ts"
      to: "mobile/src/services/styles.ts"
      via: "Hook wraps style API service with store management"
      pattern: "useStyleTransfer"
    - from: "mobile/src/screens/Styles/StylePreviewScreen.tsx"
      to: "mobile/src/components/Styles/ProgressiveImage.tsx"
      via: "Preview screen uses progressive image for low-res to HD transition"
      pattern: "ProgressiveImage"
---

<objective>
Build the complete artistic style pipeline: backend Fast Neural Style Transfer infrastructure with preset management and Celery tasks, plus the mobile style gallery and preview screens with progressive image loading.

Purpose: Users can transform their processed iris photos into art using curated preset styles (5-10 free, 10-15 premium), completing the core artistic value proposition of the app.

Output: Backend style models, Celery tasks, API routes; mobile style gallery, style preview screen with progressive enhancement.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-camera-guidance-and-artistic-styles/04-RESEARCH.md
@.planning/phases/03-ai-processing-pipeline/03-01-SUMMARY.md
@.planning/phases/03-ai-processing-pipeline/03-02-SUMMARY.md
@.planning/phases/03-ai-processing-pipeline/03-03-SUMMARY.md
@backend/app/workers/models/model_cache.py
@backend/app/workers/tasks/processing.py
@backend/app/api/routes/processing.py
@backend/app/schemas/processing.py
@mobile/src/services/processing.ts
@mobile/src/hooks/useJobProgress.ts
@mobile/src/store/processingStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend style preset models, style transfer engine, Celery tasks, and API routes</name>
  <files>
    backend/app/models/style_preset.py
    backend/app/models/style_job.py
    backend/app/schemas/styles.py
    backend/app/services/styles.py
    backend/app/workers/models/style_transfer_model.py
    backend/app/workers/models/model_cache.py
    backend/app/workers/tasks/style_transfer.py
    backend/app/api/routes/styles.py
    backend/app/main.py
    backend/requirements.txt
  </files>
  <action>
Build the backend infrastructure for artistic style presets and style transfer processing.

**Database Models:**

1. **backend/app/models/style_preset.py** — StylePreset model:
   - Fields: `id` (UUID), `name` (str, unique), `display_name` (str), `description` (str), `category` (enum: "abstract", "watercolor", "oil_painting", "geometric", "cosmic", "nature", "pop_art", "minimalist"), `tier` (enum: "free", "premium"), `thumbnail_s3_key` (str, nullable — will store a reference preview), `model_s3_key` (str — path to ONNX model in S3 or local weights dir), `sort_order` (int), `is_active` (bool, default True), `created_at`, `updated_at`
   - Add `__tablename__ = "style_presets"`
   - This is a configuration table — seed with initial style definitions

2. **backend/app/models/style_job.py** — StyleJob model:
   - Fields: `id` (UUID), `user_id` (FK to users), `photo_id` (FK to photos), `processing_job_id` (FK to processing_jobs, nullable — links to the processed iris), `style_preset_id` (FK to style_presets), `status` (enum: "pending", "processing", "completed", "failed"), `progress` (int 0-100), `current_step` (str), `celery_task_id` (str), `preview_s3_key` (str, nullable — low-res preview), `result_s3_key` (str, nullable — full-res result), `result_width` (int, nullable), `result_height` (int, nullable), `processing_time_ms` (int, nullable), `error_type` (str, nullable), `error_message` (str, nullable), `created_at`, `updated_at`
   - Relationships: user, photo, style_preset, processing_job
   - Same error classification pattern as ProcessingJob (quality_issue, transient_error, server_error)

3. Create Alembic migration for both tables. Seed the style_presets table with initial preset definitions:
   - **Free styles (5):** "Cosmic Iris" (cosmic), "Watercolor Dream" (watercolor), "Pop Vision" (pop_art), "Minimal Lines" (minimalist), "Nature's Eye" (nature)
   - **Premium styles (10):** "Oil Master" (oil_painting), "Neon Pulse" (abstract), "Crystal Geometry" (geometric), "Aurora Flow" (cosmic), "Monet's Garden" (watercolor), "Stained Glass" (geometric), "Digital Glitch" (abstract), "Golden Hour" (nature), "Ink Wash" (minimalist), "Fire & Ice" (abstract)
   - Each with sort_order, tier, and model_s3_key pointing to `styles/{name}.onnx` (placeholder paths — actual models loaded later)

**Schemas:**

4. **backend/app/schemas/styles.py** — Pydantic schemas:
   - `StylePresetResponse`: id, name, display_name, description, category, tier, thumbnail_url (presigned), sort_order
   - `StyleListResponse`: free (list of StylePresetResponse), premium (list of StylePresetResponse)
   - `StyleJobSubmitRequest`: photo_id (UUID), style_preset_id (UUID), processing_job_id (UUID, optional — if omitted, apply style to original photo)
   - `StyleJobResponse`: id, status, progress, current_step, preview_url (presigned), result_url (presigned), style_preset (nested), processing_time_ms
   - `StyleJobListResponse`: items (list), total (int)

**Service:**

5. **backend/app/services/styles.py**:
   - `list_presets(active_only=True)`: Return all active presets grouped by tier (free first, then premium by sort_order)
   - `get_preset(preset_id)`: Get single preset
   - `create_style_job(user_id, photo_id, style_preset_id, processing_job_id)`: Create StyleJob record, submit Celery task, return job
   - `get_style_job(job_id, user_id)`: Get job with presigned URLs for preview and result
   - `list_style_jobs(user_id, photo_id=None, limit=20, offset=0)`: List user's style jobs, optionally filtered by photo

**Style Transfer Model:**

6. **backend/app/workers/models/style_transfer_model.py** — StyleTransferModel class:
   - Wraps ONNX Runtime inference for Fast Neural Style Transfer
   - `load(model_path)`: Load ONNX model with CUDAExecutionProvider (fallback to CPU)
   - `apply(image: np.ndarray, output_size: tuple) -> np.ndarray`:
     - Preprocess: resize input to model input size (512x512), normalize to [0,1], convert HWC->CHW, add batch dim
     - Run ONNX inference
     - Postprocess: remove batch dim, CHW->HWC, denormalize, clip to [0,255], resize to output_size
   - **Dev-mode fallback:** If ONNX model file not found, apply a simple OpenCV artistic filter as simulation:
     - Use `cv2.stylization(image, sigma_s=60, sigma_r=0.07)` for a painterly effect
     - This ensures the pipeline works end-to-end without real model weights
   - Cache loaded models by style name (class-level dict, similar to ModelCache pattern)

7. **Update backend/app/workers/models/model_cache.py**:
   - Add `_style_models: dict[str, StyleTransferModel] = {}` class-level cache
   - Add `get_style_model(style_name: str, model_path: str) -> StyleTransferModel`: Lazy-load and cache per style name
   - Add `clear_style_models()`: Clear style model cache (for memory management when switching to SD tasks)

**Celery Task:**

8. **backend/app/workers/tasks/style_transfer.py** — `apply_style_preset` task:
   - Inherit from RetryableProcessingTask (same base as processing tasks)
   - Route to `high_priority` queue
   - Steps:
     1. "Preparing your canvas..." (0-10%): Load source image from S3 (processed iris if processing_job_id provided, else original photo)
     2. "Applying artistic style..." (10-70%): Load style model via ModelCache, apply style transfer. Generate both preview (256x256 JPEG quality 70) and full-res (1024x1024 JPEG quality 90)
     3. "Adding final touches..." (70-90%): Upload preview and full result to S3 at `styled/{user_id}/{job_id}_preview.jpg` and `styled/{user_id}/{job_id}.jpg`
     4. "Almost done..." (90-100%): Update StyleJob in database with result keys, dimensions, processing_time_ms
   - Dual state updates: Celery state (for WebSocket polling) + database (for persistence) — same pattern as processing.py
   - on_failure handler: Clean up partial S3 objects, set error_type and error_message
   - Magical step names for user-facing display

**API Routes:**

9. **backend/app/api/routes/styles.py**:
   - `GET /api/v1/styles/presets`: List all active presets (public — used for browsing, no auth required for listing but auth for submission)
   - `POST /api/v1/styles/apply`: Submit style application job (auth required). Accepts StyleJobSubmitRequest, returns StyleJobResponse
   - `GET /api/v1/styles/jobs/{job_id}`: Get style job status with presigned URLs (auth required)
   - `GET /api/v1/styles/jobs`: List user's style jobs, optional `?photo_id=` filter (auth required)
   - All endpoints follow existing patterns from processing.py routes

10. **Update backend/app/main.py**: Register styles router at `/api/v1/styles`

11. **Update backend/requirements.txt**: No new dependencies needed — ONNX Runtime, OpenCV, Pillow already installed from Phase 3. If not present, ensure `onnxruntime` and `opencv-python-headless` are in requirements.txt.

**Important implementation details:**
- Follow exact same patterns as Phase 3 processing pipeline (ProcessingJob model structure, Celery task pattern, API route pattern, dual state updates)
- The WebSocket at `/ws/jobs/{job_id}` already exists from Phase 3 — it reads Celery task state generically. Update the WebSocket endpoint to also handle style jobs OR create a parallel `/ws/style-jobs/{job_id}` endpoint with the same polling pattern. Prefer extending the existing WebSocket to check both processing jobs and style jobs.
- Style step names should be magical (same philosophy as Phase 3): "Preparing your canvas...", "Applying artistic style...", "Adding final touches...", "Almost done..."
- The dev-mode fallback using cv2.stylization is critical — it lets the full pipeline work without downloading ONNX models
  </action>
  <verify>
    - `cd backend && python -c "from app.models.style_preset import StylePreset; from app.models.style_job import StyleJob; print('Models OK')"` succeeds
    - `cd backend && python -c "from app.schemas.styles import StylePresetResponse, StyleJobSubmitRequest; print('Schemas OK')"` succeeds
    - `cd backend && python -c "from app.api.routes.styles import router; print('Router OK')"` succeeds
    - `cd backend && python -c "from app.workers.tasks.style_transfer import apply_style_preset; print('Task OK')"` succeeds
    - `grep "styles" backend/app/main.py` confirms router registered
    - Alembic migration file exists for style_presets and style_jobs tables
  </verify>
  <done>
    - StylePreset and StyleJob models created with Alembic migration
    - 15 style presets seeded (5 free, 10 premium)
    - StyleTransferModel wraps ONNX inference with dev-mode OpenCV fallback
    - apply_style_preset Celery task generates preview (256px) and full-res (1024px) results
    - REST API provides preset listing, job submission, and job status with presigned URLs
    - Styles router registered in main.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile style gallery, style preview screen, and progressive image loading</name>
  <files>
    mobile/src/types/styles.ts
    mobile/src/services/styles.ts
    mobile/src/hooks/useStyleTransfer.ts
    mobile/src/store/styleStore.ts
    mobile/src/components/Styles/StyleThumbnail.tsx
    mobile/src/components/Styles/StyleGrid.tsx
    mobile/src/components/Styles/ProgressiveImage.tsx
    mobile/src/screens/Styles/StyleGalleryScreen.tsx
    mobile/src/screens/Styles/StylePreviewScreen.tsx
    mobile/src/navigation/types.ts
    mobile/src/navigation/RootNavigator.tsx
  </files>
  <action>
Build the mobile style browsing and preview UI, connecting to the backend style API.

**Types:**

1. **mobile/src/types/styles.ts**:
   - `StylePreset`: id, name, displayName, description, category, tier ('free' | 'premium'), thumbnailUrl, sortOrder
   - `StyleJob`: id, status, progress, currentStep, previewUrl, resultUrl, stylePreset (nested), processingTimeMs
   - `StyleListResponse`: free (StylePreset[]), premium (StylePreset[])
   - `GuidanceState` type for the style transfer progress

**API Service:**

2. **mobile/src/services/styles.ts**:
   - `getStylePresets()`: GET `/api/v1/styles/presets`, returns StyleListResponse
   - `applyStyle(photoId, stylePresetId, processingJobId?)`: POST `/api/v1/styles/apply`, returns StyleJob
   - `getStyleJob(jobId)`: GET `/api/v1/styles/jobs/{jobId}`, returns StyleJob
   - `getStyleJobs(photoId?)`: GET `/api/v1/styles/jobs`, returns list
   - Use existing `api` axios instance from services/api.ts (already has JWT interceptor)

**Store:**

3. **mobile/src/store/styleStore.ts** — Zustand store:
   - State: `activeJobs: Record<string, StyleJob>`, `selectedPreset: StylePreset | null`
   - Actions: `addJob(job)`, `updateJob(jobId, updates)`, `removeJob(jobId)`, `setSelectedPreset(preset)`, `getJobForPhoto(photoId)`
   - Same pattern as processingStore.ts

**Hook:**

4. **mobile/src/hooks/useStyleTransfer.ts**:
   - `useStyleTransfer(photoId, processingJobId?)` hook
   - `applyStyle(presetId)`: Submit style job, add to store, return job
   - `activeJob`: Current active style job for this photo (from store)
   - Uses WebSocket progress hook (reuse useJobProgress pattern from Phase 3) to track style job progress
   - Auto-updates store when WebSocket sends progress/completion/error
   - `presets`: Cached style presets fetched via React Query (`useQuery('stylePresets', getStylePresets)`)

**Components:**

5. **mobile/src/components/Styles/StyleThumbnail.tsx**:
   - Renders a single style preset as a card/thumbnail
   - Shows: style name, category badge, thumbnail image (or placeholder gradient if no thumbnail)
   - Premium styles: Show a small lock icon overlay and "Premium" badge
   - Free styles: No lock, available to tap
   - On tap: If free, call `onSelect(preset)`. If premium, call `onPremiumTap(preset)` (will show "Coming in future update" or similar — payment is Phase 6)
   - Dimensions: approximately 160x160px card with rounded corners and subtle shadow

6. **mobile/src/components/Styles/StyleGrid.tsx**:
   - Renders a grid of StyleThumbnail components using FlatList with 3 columns
   - Section headers: "Free Styles" and "Premium Styles" (with lock icon)
   - SectionList or two FlatLists in a ScrollView (prefer SectionList for semantic grouping)
   - Empty state: "No styles available" if API returns empty
   - Loading state: skeleton placeholders while fetching

7. **mobile/src/components/Styles/ProgressiveImage.tsx**:
   - Displays an image that transitions from low-res preview to full-res result
   - Props: `previewUrl` (low-res, 256px), `fullUrl` (full-res, 1024px), `onFullLoaded` callback
   - Implementation: Render two Image components stacked. Start with previewUrl visible (blurred slightly via `blurRadius={3}`). When fullUrl loads successfully, fade out the preview and fade in the full image using Reanimated opacity animation (300ms cross-fade)
   - Shows a subtle loading indicator while full-res is loading
   - If only previewUrl available (HD still generating), show preview with "Enhancing..." label

**Screens:**

8. **mobile/src/screens/Styles/StyleGalleryScreen.tsx**:
   - Entry point for style browsing — user arrives here from a "Style" button on ProcessingResultScreen or PhotoDetailScreen
   - Route params: `photoId` (required), `processingJobId` (optional — if from a processed result), `originalImageUrl` (the source iris image URL for before/after)
   - Renders: Header with source iris thumbnail + "Choose a Style" title, then StyleGrid
   - On style select (free): Navigate to StylePreviewScreen with preset info
   - On premium tap: Show Alert "Premium styles coming soon!" (placeholder — Phase 6 adds payment)
   - Uses React Query to fetch presets, shows loading skeleton during fetch

9. **mobile/src/screens/Styles/StylePreviewScreen.tsx**:
   - Shows the styled result with before/after comparison
   - Route params: `photoId`, `stylePresetId`, `processingJobId`, `originalImageUrl`
   - On mount: Submit style job via `useStyleTransfer.applyStyle(stylePresetId)`
   - **While processing:** Show progress indicator with magical step name (from WebSocket), source image with overlay shimmer
   - **When preview ready:** Show ProgressiveImage with preview (low-res styled), source image in small thumbnail for comparison
   - **When full result ready:** ProgressiveImage transitions to full-res
   - **Actions bar at bottom:**
     - "Try Another Style" → Navigate back to StyleGalleryScreen
     - "Save" → Save to device CameraRoll (reuse pattern from ProcessingResultScreen)
     - "Share" → Share via Share API (reuse pattern from ProcessingResultScreen)
   - **Error state:** Show error message with "Try Again" button (resubmit style job)
   - Header shows style name

**Navigation:**

10. **Update mobile/src/navigation/types.ts**:
    - Add `StyleGallery` route: `{ photoId: string, processingJobId?: string, originalImageUrl: string }`
    - Add `StylePreview` route: `{ photoId: string, stylePresetId: string, processingJobId?: string, originalImageUrl: string }`

11. **Update mobile/src/navigation/RootNavigator.tsx**:
    - Register StyleGallery and StylePreview screens in MainStack

**Integration points (do NOT modify these files, just reference them):**
- ProcessingResultScreen already exists — a future minor update will add a "Style It" button that navigates to StyleGallery. For now, StyleGallery is reachable via navigation and can be linked from PhotoDetail or ProcessingResult in a later pass.
- The existing WebSocket endpoint at `/ws/jobs/{job_id}` should work for style jobs IF the backend task (Task 1) writes Celery state in the same format. The useJobProgress hook from Phase 3 can be reused as-is.

**Important notes:**
- Follow same patterns as Phase 3 mobile implementation (services, hooks, store, screens)
- Use existing FastImage for style preset thumbnails (immutable caching)
- React Query key for presets: `['stylePresets']` — rarely changes, set `staleTime: 5 * 60 * 1000` (5 min)
- For the "Style It" entry point: Add a "Style It" button to PhotoDetailScreen header (next to existing "Process" button) that navigates to StyleGallery. This is a small modification to an existing screen.
  </action>
  <verify>
    - `cd mobile && npx tsc --noEmit` passes
    - `grep -r "StyleGalleryScreen" mobile/src/navigation/RootNavigator.tsx` confirms registration
    - `grep -r "StylePreviewScreen" mobile/src/navigation/RootNavigator.tsx` confirms registration
    - `grep -r "api/v1/styles" mobile/src/services/styles.ts` confirms API integration
    - All component files exist in mobile/src/components/Styles/
    - All screen files exist in mobile/src/screens/Styles/
  </verify>
  <done>
    - Style types, API service, Zustand store, and hook all created
    - StyleGallery screen shows free and premium presets in a grid
    - Premium presets show lock icon and "coming soon" on tap
    - StylePreview screen submits style job, shows WebSocket progress, displays progressive image result
    - ProgressiveImage component cross-fades from preview to full-res
    - Navigation routes registered for StyleGallery and StylePreview
  </done>
</task>

</tasks>

<verification>
1. Backend: `cd backend && python -c "from app.api.routes.styles import router; from app.workers.tasks.style_transfer import apply_style_preset; print('Backend OK')"` — imports succeed
2. Backend: Alembic migration exists and style_presets/style_jobs tables created
3. Backend: 15 style presets seeded (5 free, 10 premium)
4. Mobile: `cd mobile && npx tsc --noEmit` — TypeScript compiles without errors
5. Mobile: StyleGallery and StylePreview screens registered in navigation
6. Mobile: Style API service connects to backend endpoints
7. Integration: Style job uses same WebSocket progress pattern as processing jobs
</verification>

<success_criteria>
- Backend has StylePreset and StyleJob models with seeded presets
- Style transfer Celery task generates preview (256px) and full-res (1024px) with dev-mode OpenCV fallback
- REST API provides preset listing and job management
- Mobile style gallery shows free and premium presets with clear visual distinction
- Mobile style preview shows progressive enhancement (low-res preview to full-res)
- WebSocket progress works for style jobs using existing infrastructure
</success_criteria>

<output>
After completion, create `.planning/phases/04-camera-guidance-and-artistic-styles/04-02-SUMMARY.md`
</output>

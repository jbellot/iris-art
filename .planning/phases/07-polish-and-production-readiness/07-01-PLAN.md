---
phase: 07-polish-and-production-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/conftest.py
  - backend/tests/test_health.py
  - backend/tests/test_auth.py
  - backend/pytest.ini
  - backend/requirements.txt
  - backend/Dockerfile
  - backend/.dockerignore
  - backend/app/main.py
  - backend/app/core/config.py
  - backend/app/api/routes/health.py
  - .github/workflows/backend-ci.yml
  - .github/workflows/mobile-android.yml
  - mobile/index.js
  - mobile/package.json
  - mobile/sentry.properties
autonomous: true

must_haves:
  truths:
    - "Backend pytest suite runs and passes with smoke tests for health and auth endpoints"
    - "GitHub Actions backend-ci workflow runs tests, lints, and builds Docker image on push to main"
    - "GitHub Actions mobile-android workflow builds APK with caching on push to main"
    - "Sentry captures errors in both backend (FastAPI + Celery) and mobile (React Native with Hermes)"
    - "Health check /health/readiness returns combined DB + Redis + MinIO status for container orchestration"
    - "Backend Docker image uses multi-stage build with non-root user"
  artifacts:
    - path: "backend/tests/conftest.py"
      provides: "Pytest fixtures for async FastAPI test client with DB override"
      contains: "AsyncClient"
    - path: "backend/tests/test_health.py"
      provides: "Smoke tests for health endpoints"
      contains: "test_liveness"
    - path: "backend/tests/test_auth.py"
      provides: "Smoke tests for auth registration and login"
      contains: "test_register"
    - path: ".github/workflows/backend-ci.yml"
      provides: "Backend CI pipeline"
      contains: "pytest"
    - path: ".github/workflows/mobile-android.yml"
      provides: "Android build pipeline"
      contains: "assembleRelease"
    - path: "mobile/sentry.properties"
      provides: "Sentry config for source map upload"
      contains: "defaults.org"
  key_links:
    - from: ".github/workflows/backend-ci.yml"
      to: "backend/tests/"
      via: "pytest command in CI job"
      pattern: "pytest backend/tests"
    - from: "backend/app/main.py"
      to: "sentry_sdk"
      via: "Sentry initialization at app startup"
      pattern: "sentry_sdk.init"
    - from: "mobile/index.js"
      to: "@sentry/react-native"
      via: "Sentry.init before AppRegistry"
      pattern: "Sentry.init"
---

<objective>
Set up CI/CD pipelines, backend testing, production monitoring with Sentry, and optimize the Docker build for production deployment.

Purpose: The app needs automated quality gates (tests in CI), visibility into production errors (Sentry), and an optimized build pipeline to support continuous delivery and fast debugging.

Output: GitHub Actions workflows for backend and mobile, pytest smoke test suite, Sentry integration in both backend and mobile, multi-stage production Dockerfile.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-and-production-readiness/07-RESEARCH.md

Key existing files:
- backend/app/main.py — FastAPI app entry (needs Sentry init)
- backend/app/core/config.py — Settings class (needs SENTRY_DSN, ENVIRONMENT)
- backend/app/api/routes/health.py — Existing /health, /health/db, /health/redis (needs /health/readiness and /health/liveness)
- backend/Dockerfile — Single-stage build (needs multi-stage optimization)
- backend/docker-compose.yml — Dev stack (reference for CI services)
- backend/requirements.txt — Current dependencies (needs pytest, sentry-sdk)
- mobile/index.js — App entry point (needs Sentry.init wrapper)
- mobile/package.json — Mobile deps (needs @sentry/react-native)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend testing, Sentry, multi-stage Dockerfile, and health improvements</name>
  <files>
    backend/tests/__init__.py
    backend/tests/conftest.py
    backend/tests/test_health.py
    backend/tests/test_auth.py
    backend/pytest.ini
    backend/requirements.txt
    backend/Dockerfile
    backend/.dockerignore
    backend/app/main.py
    backend/app/core/config.py
    backend/app/api/routes/health.py
  </files>
  <action>
    **1. Add test dependencies to requirements.txt:**
    Append to backend/requirements.txt:
    ```
    # Testing
    pytest>=7.4.0
    pytest-asyncio>=0.21.0
    pytest-cov>=4.1.0
    # Monitoring
    sentry-sdk[fastapi]>=1.40.0
    ```

    **2. Create backend/pytest.ini:**
    ```ini
    [pytest]
    asyncio_mode = auto
    testpaths = tests
    python_files = test_*.py
    python_functions = test_*
    ```

    **3. Create backend/tests/__init__.py** (empty file)

    **4. Create backend/tests/conftest.py:**
    - Create async test engine using TEST_DATABASE_URL (postgresql+asyncpg://postgres:postgres@localhost:5432/iris_art_test)
    - Session-scoped fixture `test_engine` that creates all tables on setup and drops on teardown using Base.metadata
    - Function-scoped fixture `test_session` that creates AsyncSession, yields it, then rolls back
    - Function-scoped fixture `client` that overrides `get_session` dependency, creates httpx.AsyncClient(transport=ASGITransport(app=app)) with base_url="http://test"
    - Import Base from app.core.db, app from app.main, get_session from app.api.deps

    **5. Create backend/tests/test_health.py:**
    - `test_liveness`: GET /health returns 200 with {"status": "healthy"}
    - `test_readiness`: GET /health/readiness returns 200 with {"status": "ready", "db": "ok", "redis": "ok"} (will need running DB and Redis in CI)
    - `test_health_db`: GET /health/db returns 200

    **6. Create backend/tests/test_auth.py:**
    - `test_register_success`: POST /api/v1/auth/register with valid email/password returns 201
    - `test_register_duplicate_email`: Register same email twice, second returns 409/400
    - `test_login_success`: Register user, then POST /api/v1/auth/login returns 200 with access_token
    - `test_login_wrong_password`: Login with wrong password returns 401
    - Note: Check existing auth routes to determine exact endpoints and request/response shapes. Use `from app.api.routes import auth` to find the router prefix.

    **7. Update backend/app/core/config.py:**
    Add to Settings class:
    ```python
    # Monitoring
    SENTRY_DSN: str = ""
    ENVIRONMENT: str = "development"
    ```

    **8. Update backend/app/main.py:**
    Add Sentry initialization BEFORE creating the FastAPI app:
    ```python
    import sentry_sdk
    from sentry_sdk.integrations.fastapi import FastApiIntegration
    from sentry_sdk.integrations.celery import CeleryIntegration

    if settings.SENTRY_DSN:
        sentry_sdk.init(
            dsn=settings.SENTRY_DSN,
            environment=settings.ENVIRONMENT,
            integrations=[
                FastApiIntegration(),
                CeleryIntegration(),
            ],
            traces_sample_rate=0.1,
            send_default_pii=False,
        )
    ```
    The conditional ensures Sentry is only enabled when DSN is configured (production only, not dev).

    **9. Update backend/app/api/routes/health.py:**
    Add /health/liveness and /health/readiness endpoints:
    - `/health/liveness` (GET): Simple alive check, returns {"status": "alive"} — used for container restart decisions
    - `/health/readiness` (GET): Checks DB (SELECT 1), Redis (ping), and MinIO (head_bucket or list_buckets). Returns {"status": "ready", "db": "ok", "redis": "ok", "storage": "ok"} on success, or 503 with details on failure. Use try/except per service so partial readiness is visible.
    - Keep existing /health, /health/db, /health/redis for backward compatibility

    **10. Convert backend/Dockerfile to multi-stage build:**
    ```dockerfile
    # Stage 1: Builder
    FROM python:3.12-slim AS builder
    WORKDIR /build
    RUN pip install --upgrade pip
    COPY requirements.txt .
    RUN pip install --no-cache-dir --prefix=/install -r requirements.txt

    # Stage 2: Runtime
    FROM python:3.12-slim
    RUN useradd -m -u 1000 app
    WORKDIR /code
    COPY --from=builder /install /usr/local
    COPY --chown=app:app app/ ./app/
    COPY --chown=app:app alembic/ ./alembic/
    COPY --chown=app:app alembic.ini .
    USER app
    EXPOSE 8000
    CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
    ```

    **11. Create/update backend/.dockerignore:**
    ```
    __pycache__
    *.pyc
    .git
    .env
    .env.*
    tests/
    .pytest_cache
    .coverage
    *.egg-info
    dist/
    build/
    .venv
    venv
    ```
  </action>
  <verify>
    From backend/:
    - `pip install pytest pytest-asyncio pytest-cov httpx sentry-sdk[fastapi]`
    - `python -m pytest tests/test_health.py::test_liveness -v` passes (liveness needs no DB)
    - `docker build -t irisvue-backend .` succeeds (multi-stage build)
    - `docker images irisvue-backend` shows image size (should be smaller than before)
    - Grep for `sentry_sdk.init` in backend/app/main.py
    - Grep for `SENTRY_DSN` in backend/app/core/config.py
  </verify>
  <done>
    - pytest discovers and runs backend smoke tests for health and auth
    - Backend Dockerfile is multi-stage with non-root user
    - Sentry SDK initialized conditionally in FastAPI app
    - Health endpoints include /health/liveness (simple) and /health/readiness (DB + Redis + MinIO)
    - .dockerignore excludes tests and dev artifacts from production image
  </done>
</task>

<task type="auto">
  <name>Task 2: GitHub Actions CI workflows and Sentry mobile integration</name>
  <files>
    .github/workflows/backend-ci.yml
    .github/workflows/mobile-android.yml
    mobile/index.js
    mobile/package.json
    mobile/sentry.properties
  </files>
  <action>
    **1. Create .github/workflows/backend-ci.yml:**
    ```yaml
    name: Backend CI

    on:
      push:
        branches: [main]
        paths: ['backend/**']
      pull_request:
        branches: [main]
        paths: ['backend/**']

    jobs:
      test:
        runs-on: ubuntu-latest
        services:
          postgres:
            image: postgres:15
            env:
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres
              POSTGRES_DB: iris_art_test
            ports: ['5432:5432']
            options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
          redis:
            image: redis:7-alpine
            ports: ['6379:6379']
            options: >-
              --health-cmd "redis-cli ping"
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/iris_art_test
          CELERY_BROKER_URL: redis://localhost:6379/0
          CELERY_RESULT_BACKEND: redis://localhost:6379/0
          S3_ENDPOINT: http://localhost:9000
          SECRET_KEY: test-secret-key-for-ci
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-python@v5
            with:
              python-version: '3.12'
              cache: 'pip'
              cache-dependency-path: backend/requirements.txt
          - name: Install dependencies
            run: pip install -r backend/requirements.txt
          - name: Run tests with coverage
            run: pytest backend/tests -v --cov=backend/app --cov-report=xml --cov-report=term-missing
          - name: Check coverage threshold
            run: pytest backend/tests --cov=backend/app --cov-fail-under=30

      build:
        needs: test
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        steps:
          - uses: actions/checkout@v4
          - uses: docker/setup-buildx-action@v3
          - uses: docker/login-action@v3
            with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}
          - uses: docker/build-push-action@v5
            with:
              context: backend
              push: true
              tags: |
                ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
                ghcr.io/${{ github.repository }}/backend:latest
              cache-from: type=gha
              cache-to: type=gha,mode=max
    ```

    **2. Create .github/workflows/mobile-android.yml:**
    ```yaml
    name: Android Build

    on:
      push:
        branches: [main]
        paths: ['mobile/**']
      pull_request:
        branches: [main]
        paths: ['mobile/**']

    jobs:
      lint-and-test:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v4
            with:
              node-version: '20'
              cache: 'npm'
              cache-dependency-path: mobile/package-lock.json
          - run: npm ci
            working-directory: mobile
          - name: TypeScript check
            run: npx tsc --noEmit
            working-directory: mobile
          - name: Run Jest tests
            run: npx jest --passWithNoTests --ci
            working-directory: mobile

      build-android:
        needs: lint-and-test
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v4
            with:
              node-version: '20'
              cache: 'npm'
              cache-dependency-path: mobile/package-lock.json
          - uses: actions/setup-java@v4
            with:
              distribution: 'temurin'
              java-version: '21'
          - uses: actions/cache@v4
            with:
              path: |
                ~/.gradle/caches
                ~/.gradle/wrapper
              key: ${{ runner.os }}-gradle-${{ hashFiles('mobile/android/**/*.gradle*', 'mobile/android/**/gradle-wrapper.properties') }}
              restore-keys: ${{ runner.os }}-gradle-
          - run: npm ci
            working-directory: mobile
          - name: Build Android Release APK
            working-directory: mobile/android
            run: ./gradlew assembleRelease
            env:
              KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
              KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
              KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          - uses: actions/upload-artifact@v4
            with:
              name: app-release.apk
              path: mobile/android/app/build/outputs/apk/release/app-release.apk
              retention-days: 30
    ```

    **3. Update mobile/index.js — Add Sentry initialization:**
    Add Sentry.init BEFORE AppRegistry.registerComponent:
    ```javascript
    import * as Sentry from '@sentry/react-native';
    import { AppRegistry } from 'react-native';
    import App from './src/App';
    import { name as appName } from './app.json';

    Sentry.init({
      dsn: '__SENTRY_DSN__',  // Replace with actual DSN from Sentry project
      environment: __DEV__ ? 'development' : 'production',
      enabled: !__DEV__,
      tracesSampleRate: 0.1,
      beforeSend(event) {
        // Scrub sensitive user data
        if (event.request?.cookies) {
          delete event.request.cookies;
        }
        return event;
      },
    });

    AppRegistry.registerComponent(appName, () => Sentry.wrap(App));
    ```
    Note: Use `Sentry.wrap(App)` to automatically capture React component errors.

    **4. Add @sentry/react-native to mobile/package.json:**
    Run (or add manually): `@sentry/react-native` to dependencies. Use --legacy-peer-deps if needed (React 19 peer dep conflict, per Phase 06-01 decision).

    **5. Create mobile/sentry.properties:**
    ```properties
    defaults.org=irisvue
    defaults.project=irisvue-mobile
    # Auth token set via SENTRY_AUTH_TOKEN env var in CI
    ```
    This file configures Sentry CLI for source map uploads. The auth token is NOT committed — it comes from CI secrets.
  </action>
  <verify>
    - `.github/workflows/backend-ci.yml` exists with valid YAML (python -c "import yaml; yaml.safe_load(open('.github/workflows/backend-ci.yml'))")
    - `.github/workflows/mobile-android.yml` exists with valid YAML
    - `grep "Sentry.init" mobile/index.js` finds Sentry initialization
    - `grep "@sentry/react-native" mobile/package.json` finds the dependency
    - `mobile/sentry.properties` exists with org and project defaults
    - `grep "sentry_sdk" backend/app/main.py` confirms backend Sentry integration
  </verify>
  <done>
    - GitHub Actions backend-ci.yml runs pytest with PostgreSQL and Redis services, builds Docker image on main push, pushes to GHCR
    - GitHub Actions mobile-android.yml runs TS check and Jest, builds release APK on main push with Gradle caching
    - Sentry React Native SDK integrated in mobile entry point with production-only enablement
    - sentry.properties configured for source map uploads (auth token via CI env)
  </done>
</task>

</tasks>

<verification>
Phase 7 Plan 01 verification:
1. `ls backend/tests/test_health.py backend/tests/test_auth.py backend/tests/conftest.py` — test files exist
2. `ls .github/workflows/backend-ci.yml .github/workflows/mobile-android.yml` — CI workflows exist
3. `grep "sentry_sdk.init" backend/app/main.py` — Sentry backend integration
4. `grep "Sentry.init" mobile/index.js` — Sentry mobile integration
5. `grep "FROM.*AS builder" backend/Dockerfile` — Multi-stage Docker build
6. `grep "useradd" backend/Dockerfile` — Non-root user in production image
7. `grep "/health/readiness" backend/app/api/routes/health.py` — Readiness probe exists
8. `grep "/health/liveness" backend/app/api/routes/health.py` — Liveness probe exists
</verification>

<success_criteria>
- Backend pytest suite discovers and runs smoke tests (health + auth endpoints)
- GitHub Actions workflows for backend CI and Android build are syntactically valid
- Sentry is integrated in both backend (FastAPI + Celery) and mobile (React Native)
- Backend Docker image uses multi-stage build with non-root user, smaller than single-stage
- Health endpoints include /health/liveness and /health/readiness for container orchestration
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-and-production-readiness/07-01-SUMMARY.md`
</output>

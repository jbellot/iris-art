---
phase: 05-social-features-circles-and-fusion
plan: 06
type: execute
wave: 3
depends_on: ["05-04"]
files_modified:
  - mobile/src/types/fusion.ts
  - mobile/src/services/fusion.ts
  - mobile/src/hooks/useFusion.ts
  - mobile/src/screens/Circles/FusionBuilderScreen.tsx
  - mobile/src/screens/Circles/CompositionBuilderScreen.tsx
  - mobile/src/screens/Circles/FusionResultScreen.tsx
  - mobile/src/screens/Circles/SharedGalleryScreen.tsx
  - mobile/src/navigation/CirclesNavigator.tsx
  - mobile/src/navigation/types.ts
autonomous: true

must_haves:
  truths:
    - "FusionBuilderScreen allows blend mode selection and submits fusion with consent gate"
    - "CompositionBuilderScreen offers 3 layout options with visual previews"
    - "FusionResultScreen shows real-time progress with magical step names and displays completed result"
    - "SharedGalleryScreen wired to navigate to fusion/composition builders from artwork selection"
    - "All screens registered in CirclesNavigator"
  artifacts:
    - path: "mobile/src/screens/Circles/FusionBuilderScreen.tsx"
      provides: "Fusion configuration and submission screen"
    - path: "mobile/src/screens/Circles/CompositionBuilderScreen.tsx"
      provides: "Side-by-side layout selection and submission screen"
    - path: "mobile/src/screens/Circles/FusionResultScreen.tsx"
      provides: "Fusion progress and result display screen"
    - path: "mobile/src/hooks/useFusion.ts"
      provides: "Fusion status polling and WebSocket progress hook"
  key_links:
    - from: "mobile/src/hooks/useFusion.ts"
      to: "/api/v1/fusion"
      via: "axios HTTP + WebSocket for progress"
      pattern: "api/v1/fusion"
    - from: "mobile/src/screens/Circles/SharedGalleryScreen.tsx"
      to: "mobile/src/screens/Circles/FusionBuilderScreen.tsx"
      via: "navigation.navigate with artworkIds"
      pattern: "FusionBuilder"
    - from: "mobile/src/navigation/CirclesNavigator.tsx"
      to: "FusionBuilder|CompositionBuilder|FusionResult"
      via: "stack navigator screen registration"
      pattern: "FusionBuilder|CompositionBuilder|FusionResult"
---

<objective>
Fusion and Composition Mobile -- FusionBuilder, CompositionBuilder, and FusionResult screens, fusion API service, progress hook, and navigation wiring from SharedGalleryScreen to builders.

Purpose: Deliver the mobile UX for creating fused and composed artwork (SOCL-04, SOCL-05). Wires the "Create Fusion" and "Side by Side" action buttons in SharedGalleryScreen to actual builder screens.
Output: FusionBuilder, CompositionBuilder, FusionResult screens, fusion service, progress hook.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-features-circles-and-fusion/05-RESEARCH.md
@.planning/phases/05-social-features-circles-and-fusion/05-02-SUMMARY.md
@.planning/phases/05-social-features-circles-and-fusion/05-04-SUMMARY.md
@.planning/phases/03-ai-processing-pipeline/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fusion types, API service, and progress hook</name>
  <files>
    mobile/src/types/fusion.ts
    mobile/src/services/fusion.ts
    mobile/src/hooks/useFusion.ts
  </files>
  <action>
    **Types** (`mobile/src/types/fusion.ts`):
    - FusionArtwork: { id, creator_id, fusion_type, blend_mode, status, result_url, thumbnail_url, source_artwork_ids, created_at, completed_at }.
    - FusionSubmitResponse: { fusion_id, status, websocket_url } | { status: "consent_required", pending: ConsentStatus[] }.

    **API Service** (`mobile/src/services/fusion.ts`):
    - `createFusion(artworkIds, circleId, blendMode)` -- POST /api/v1/fusion
    - `createComposition(artworkIds, circleId, layout)` -- POST /api/v1/composition
    - `getFusionStatus(fusionId)` -- GET /api/v1/fusion/{fusionId}
    - `getUserFusions(offset, limit)` -- GET /api/v1/fusion

    **Hook** (`mobile/src/hooks/useFusion.ts`):
    - `useFusion(fusionId)`: Combines REST polling + WebSocket progress (reuse useJobProgress hook pattern from Phase 3). Returns { status, progress, currentStep, resultUrl, thumbnailUrl, error }.
    - Magical step names for fusion: "Gathering iris artworks...", "Preparing for blending...", "Creating seamless fusion...", "Adding finishing touches...", "Almost done..."
    - Magical step names for composition: "Arranging your irises...", "Creating layout...", "Saving composition..."
  </action>
  <verify>
    Verify files exist:
    `ls mobile/src/types/fusion.ts mobile/src/services/fusion.ts mobile/src/hooks/useFusion.ts`
  </verify>
  <done>
    Fusion types, API service, and progress hook provide data layer. useFusion hook combines REST polling with WebSocket for real-time progress with magical step names.
  </done>
</task>

<task type="auto">
  <name>Task 2: Builder screens, result screen, SharedGallery wiring, and navigation registration</name>
  <files>
    mobile/src/screens/Circles/FusionBuilderScreen.tsx
    mobile/src/screens/Circles/CompositionBuilderScreen.tsx
    mobile/src/screens/Circles/FusionResultScreen.tsx
    mobile/src/screens/Circles/SharedGalleryScreen.tsx
    mobile/src/navigation/CirclesNavigator.tsx
    mobile/src/navigation/types.ts
  </files>
  <action>
    **Screens:**

    `FusionBuilderScreen.tsx`:
    - Receives artworkIds and circleId from navigation params (from SharedGalleryScreen selection).
    - Shows preview thumbnails of selected artworks in a horizontal scroll.
    - Blend mode selector: "Seamless Blend" (poisson, default) and "Simple Blend" (alpha). Brief description under each: "Gradient-based blending for seamless results" / "Quick blend with transparency overlay".
    - "Create Fusion" button.
    - On submit: call createFusion. If response is "consent_required", show alert: "Consent needed from artwork owners. Requests have been sent." with list of pending consents. Navigate to CircleDetailScreen (consent notification will appear there).
    - If fusion submitted: navigate to FusionResultScreen with fusionId.
    - Show 2-4 artworks required validation (error if <2 or >4 selected).

    `CompositionBuilderScreen.tsx`:
    - Receives artworkIds and circleId from navigation params.
    - Shows preview thumbnails.
    - Layout selector with visual previews:
      - "Side by Side" (horizontal) -- shows [img1 | img2] icon
      - "Stacked" (vertical) -- shows img1 over img2 icon
      - "Grid" (grid_2x2) -- shows 2x2 grid icon (only enabled if 3-4 artworks selected)
    - "Create Composition" button.
    - Same consent handling as FusionBuilderScreen.
    - On success: navigate to FusionResultScreen with fusionId.

    `FusionResultScreen.tsx`:
    - Receives fusionId from navigation.
    - Uses useFusion hook for real-time progress.
    - While processing: show progress bar with magical step name. Show source artwork thumbnails below progress.
    - On completion: display result image full-width. Show source artworks as small row below.
    - Action buttons: "Save to Gallery" (using CameraRoll or RN Share), "Share" (RN Share API), "Back to Circle" (navigate to CircleDetailScreen).
    - On failure: show error message with "Try Again" button (re-submit same artworks).

    **Wire SharedGalleryScreen** (update from 05-04):
    - Replace "Coming soon" toast on "Create Fusion" action button with navigation to FusionBuilderScreen passing selected artworkIds and circleId.
    - Replace "Coming soon" toast on "Side by Side" action button with navigation to CompositionBuilderScreen passing selected artworkIds and circleId.
    - Show "Fusion" button only when 2-4 artworks selected.
    - Show "Side by Side" button only when 2-4 artworks selected.

    **Navigation** (update CirclesNavigator.tsx and types.ts):
    - Register FusionBuilder, CompositionBuilder, and FusionResult screen components in CirclesNavigator stack (replacing any placeholder registrations from 05-02).
    - Update param types if needed: FusionBuilder needs { artworkIds: string[], circleId: string }, CompositionBuilder same, FusionResult needs { fusionId: string }.
  </action>
  <verify>
    Verify screen files exist:
    `ls mobile/src/screens/Circles/FusionBuilderScreen.tsx mobile/src/screens/Circles/CompositionBuilderScreen.tsx mobile/src/screens/Circles/FusionResultScreen.tsx`
    Verify navigation wiring:
    `grep -l "FusionBuilder\|CompositionBuilder\|FusionResult" mobile/src/navigation/CirclesNavigator.tsx`
    Verify SharedGallery wiring:
    `grep -l "FusionBuilder\|CompositionBuilder" mobile/src/screens/Circles/SharedGalleryScreen.tsx`
  </verify>
  <done>
    FusionBuilderScreen allows blend mode selection and submits fusion with consent gate. CompositionBuilderScreen offers 3 layout options with visual previews. FusionResultScreen shows real-time progress with magical step names and displays completed result with save/share actions. SharedGalleryScreen wired to navigate to fusion/composition builders from artwork selection. All screens registered in CirclesNavigator.
  </done>
</task>

</tasks>

<verification>
- Mobile: FusionBuilder submits fusion and handles consent_required response
- Mobile: CompositionBuilder shows 3 layout options with visual previews
- Mobile: FusionResult shows real-time progress and completed result
- Mobile: SharedGallery action buttons navigate to FusionBuilder and CompositionBuilder
- Integration: Full flow from SharedGallery selection -> Builder -> Result works end-to-end
</verification>

<success_criteria>
- FusionBuilderScreen allows blend mode selection (poisson/alpha) and handles consent-required responses
- CompositionBuilderScreen offers horizontal, vertical, grid_2x2 layouts with visual icons
- FusionResultScreen shows real-time progress with magical step names and save/share actions
- SharedGalleryScreen "Create Fusion" and "Side by Side" buttons navigate to respective builders
- All three screens registered in CirclesNavigator with correct param types
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-features-circles-and-fusion/05-06-SUMMARY.md`
</output>

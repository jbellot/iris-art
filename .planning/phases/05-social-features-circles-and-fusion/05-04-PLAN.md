---
phase: 05-social-features-circles-and-fusion
plan: 04
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - mobile/src/types/consent.ts
  - mobile/src/services/consent.ts
  - mobile/src/screens/Circles/SharedGalleryScreen.tsx
  - mobile/src/screens/Circles/CircleDetailScreen.tsx
  - mobile/src/components/Circles/ConsentModal.tsx
  - mobile/src/components/Circles/ArtworkCard.tsx
  - mobile/src/hooks/useCircleGallery.ts
autonomous: true

must_haves:
  truths:
    - "SharedGalleryScreen displays all active members' artwork in 2-column grid with owner badges"
    - "ArtworkCard supports selection mode for future fusion/composition"
    - "ConsentModal shows pending consent requests with allow/deny buttons"
    - "CircleDetailScreen links to shared gallery and shows consent notification badge"
    - "Selection of 2+ artworks reveals fusion/composition action buttons (disabled placeholders until 05-06)"
  artifacts:
    - path: "mobile/src/screens/Circles/SharedGalleryScreen.tsx"
      provides: "Cross-member gallery view for circle"
    - path: "mobile/src/components/Circles/ConsentModal.tsx"
      provides: "Consent approval/deny dialog"
    - path: "mobile/src/components/Circles/ArtworkCard.tsx"
      provides: "Artwork card with selection and owner badge"
    - path: "mobile/src/hooks/useCircleGallery.ts"
      provides: "Gallery data fetching hook"
  key_links:
    - from: "mobile/src/hooks/useCircleGallery.ts"
      to: "/api/v1/circles/{circleId}/gallery"
      via: "axios HTTP call"
      pattern: "api/v1/circles.*gallery"
    - from: "mobile/src/services/consent.ts"
      to: "/api/v1/consent"
      via: "axios HTTP calls"
      pattern: "api/v1/consent"
    - from: "mobile/src/screens/Circles/CircleDetailScreen.tsx"
      to: "mobile/src/screens/Circles/SharedGalleryScreen.tsx"
      via: "navigation.navigate"
      pattern: "SharedGallery"
---

<objective>
Shared Gallery and Consent Mobile -- SharedGalleryScreen showing cross-member artwork, ArtworkCard with selection mode, ConsentModal for approve/deny, and gallery hook. Wires the "Shared Gallery" button in CircleDetailScreen.

Purpose: Give circle members a visual gallery of shared artwork (SOCL-03) and a consent flow UI (SOCL-06). Users need to see and select art before fusion features (05-06).
Output: SharedGalleryScreen, ArtworkCard, ConsentModal, consent service, gallery hook.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-features-circles-and-fusion/05-RESEARCH.md
@.planning/phases/05-social-features-circles-and-fusion/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consent types, service, gallery hook, and reusable components</name>
  <files>
    mobile/src/types/consent.ts
    mobile/src/services/consent.ts
    mobile/src/hooks/useCircleGallery.ts
    mobile/src/components/Circles/ArtworkCard.tsx
    mobile/src/components/Circles/ConsentModal.tsx
  </files>
  <action>
    **Types** (`mobile/src/types/consent.ts`):
    - ConsentRequest: { id, artwork_id, grantor_user_id, grantee_user_id, purpose, status, requested_at }.
    - PendingConsent: { id, artwork_id, artwork_preview_url, grantee_email, purpose, circle_name, requested_at }.
    - ConsentStatus: { artwork_id, status: 'self' | 'granted' | 'pending' | 'denied' | 'none' }.

    **API Service** (`mobile/src/services/consent.ts`):
    - `requestConsent(artworkIds, purpose, circleId)` -- POST /api/v1/consent/request
    - `getPendingConsents()` -- GET /api/v1/consent/pending
    - `decideConsent(consentId, decision)` -- POST /api/v1/consent/{consentId}/decide
    - `revokeConsent(consentId)` -- POST /api/v1/consent/{consentId}/revoke
    - `getConsentStatus(artworkIds, purpose)` -- GET /api/v1/consent/status

    **Hook** (`mobile/src/hooks/useCircleGallery.ts`):
    - `useCircleGallery(circleId)`: Fetches shared gallery with pagination (manual offset tracking). Returns { artworks, loading, error, loadMore, refresh }. Each artwork includes owner info and thumbnail URL.

    **Components:**

    `ArtworkCard.tsx`:
    - Displays artwork thumbnail with owner email/name badge at bottom.
    - Supports selection mode (checkmark overlay when selected, blue border).
    - Shows "Your Art" badge for self-owned artworks.
    - Props: artwork, isSelected, onPress, onLongPress, showOwner.
    - Use FastImage for image caching (same pattern as Phase 2 gallery).

    `ConsentModal.tsx`:
    - Modal dialog shown when user has pending consent requests.
    - Shows artwork thumbnail preview, requester email, purpose ("wants to use your iris art for fusion").
    - Two buttons: "Allow" (calls decideConsent with "granted") and "Deny" (calls decideConsent with "denied").
    - Swipeable list of pending consents if multiple.
    - Dismiss closes modal.
  </action>
  <verify>
    Verify files exist:
    `ls mobile/src/types/consent.ts mobile/src/services/consent.ts mobile/src/hooks/useCircleGallery.ts mobile/src/components/Circles/ArtworkCard.tsx mobile/src/components/Circles/ConsentModal.tsx`
  </verify>
  <done>
    Consent types, API service, and gallery hook provide data layer. ArtworkCard supports selection mode with owner badge. ConsentModal enables approve/deny flow for artwork usage requests.
  </done>
</task>

<task type="auto">
  <name>Task 2: SharedGalleryScreen and CircleDetailScreen wiring</name>
  <files>
    mobile/src/screens/Circles/SharedGalleryScreen.tsx
    mobile/src/screens/Circles/CircleDetailScreen.tsx
  </files>
  <action>
    **SharedGalleryScreen.tsx:**
    - Receives circleId from navigation params.
    - Uses useCircleGallery hook for data.
    - FlashList 2-column grid of ArtworkCard components (same masonry pattern as Phase 2 gallery).
    - Each card shows artwork thumbnail + owner badge.
    - Selection mode: tap to select artworks (selection state managed locally). When 2+ artworks selected, show floating action buttons: "Create Fusion" and "Side by Side". These buttons show a "Coming soon" toast for now -- actual navigation to FusionBuilder/CompositionBuilder screens will be wired in 05-06 when those screens exist.
    - Pull-to-refresh.
    - Empty state: "No artwork shared yet. Members' processed iris art appears here."
    - Header shows circle name and member count.

    **Update CircleDetailScreen.tsx** (from 05-02):
    - Wire "Shared Gallery" button to navigate to SharedGalleryScreen with circleId (replace the disabled placeholder from 05-02 with actual navigation).
    - Add consent notification badge: fetch pending consents count, show red badge on a "Consent Requests" button/icon if count > 0. Tapping opens ConsentModal.
  </action>
  <verify>
    Verify screen exists:
    `ls mobile/src/screens/Circles/SharedGalleryScreen.tsx`
    Verify CircleDetail wiring:
    `grep -l "SharedGallery\|ConsentModal" mobile/src/screens/Circles/CircleDetailScreen.tsx`
  </verify>
  <done>
    SharedGalleryScreen displays all active members' artwork in 2-column grid with owner badges and selection mode. CircleDetailScreen navigates to SharedGalleryScreen and shows consent notification badge. Fusion/composition buttons exist as "Coming soon" placeholders (wired in 05-06).
  </done>
</task>

</tasks>

<verification>
- Mobile: SharedGallery renders 2-column grid with owner badges
- Mobile: ConsentModal correctly shows pending requests and sends grant/deny decisions
- Mobile: CircleDetailScreen navigates to SharedGallery and shows consent badge
- Selection of 2+ artworks shows action buttons (placeholder toast)
</verification>

<success_criteria>
- SharedGalleryScreen shows 2-column grid with owner identification and selection mode
- ArtworkCard supports selection (checkmark, blue border) and owner badge
- ConsentModal enables approve/deny flow for artwork usage requests
- Consent notification badge shows count of pending requests on CircleDetailScreen
- "Create Fusion" and "Side by Side" buttons show "Coming soon" toast (wired in 05-06)
- CircleDetailScreen "Shared Gallery" button navigates to SharedGalleryScreen
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-features-circles-and-fusion/05-04-SUMMARY.md`
</output>

---
phase: 05-social-features-circles-and-fusion
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - backend/app/models/fusion_artwork.py
  - backend/app/schemas/fusion.py
  - backend/app/services/fusion_service.py
  - backend/app/workers/tasks/fusion_blending.py
  - backend/app/workers/tasks/composition.py
  - backend/app/api/routes/fusion.py
  - backend/app/models/__init__.py
  - backend/app/models/user.py
  - backend/app/main.py
  - backend/alembic/versions/f6a7b8c9d0e1_add_fusion_artworks.py
  - mobile/src/types/fusion.ts
  - mobile/src/services/fusion.ts
  - mobile/src/hooks/useFusion.ts
  - mobile/src/screens/Circles/FusionBuilderScreen.tsx
  - mobile/src/screens/Circles/CompositionBuilderScreen.tsx
  - mobile/src/screens/Circles/FusionResultScreen.tsx
  - mobile/src/screens/Circles/SharedGalleryScreen.tsx
  - mobile/src/navigation/CirclesNavigator.tsx
  - mobile/src/navigation/types.ts
autonomous: true

must_haves:
  truths:
    - "User can blend 2-4 iris artworks into a fused composition using Poisson blending"
    - "User can compose 2-4 iris artworks side-by-side in horizontal, vertical, or 2x2 grid layout"
    - "Fusion requires all non-self artworks to have granted consent before proceeding"
    - "Composition requires all non-self artworks to have granted consent before proceeding"
    - "Fusion runs as async Celery task with WebSocket progress updates"
    - "Composition runs synchronously (fast enough) or as a lightweight Celery task"
    - "Fusion result is saved to S3 and associated with the creating user and optional circle"
    - "Alpha blending fallback is used if Poisson blending fails"
  artifacts:
    - path: "backend/app/models/fusion_artwork.py"
      provides: "FusionArtwork model tracking fusion and composition results"
      contains: "class FusionArtwork"
    - path: "backend/app/workers/tasks/fusion_blending.py"
      provides: "Celery task for Poisson blending fusion"
      contains: "create_fusion_artwork"
    - path: "backend/app/workers/tasks/composition.py"
      provides: "Side-by-side composition using OpenCV hconcat/vconcat"
      contains: "create_composition"
    - path: "backend/app/services/fusion_service.py"
      provides: "Fusion business logic with consent verification"
      contains: "submit_fusion|submit_composition"
    - path: "backend/app/api/routes/fusion.py"
      provides: "Fusion and composition REST API"
      exports: ["router"]
    - path: "mobile/src/screens/Circles/FusionBuilderScreen.tsx"
      provides: "Fusion configuration and submission screen"
    - path: "mobile/src/screens/Circles/CompositionBuilderScreen.tsx"
      provides: "Side-by-side layout selection and submission screen"
  key_links:
    - from: "backend/app/services/fusion_service.py"
      to: "backend/app/services/consent_service.py"
      via: "check_all_consents_granted before fusion"
      pattern: "check_all_consents_granted"
    - from: "backend/app/workers/tasks/fusion_blending.py"
      to: "cv2.seamlessClone"
      via: "Poisson blending call"
      pattern: "seamlessClone"
    - from: "mobile/src/hooks/useFusion.ts"
      to: "/api/v1/fusion"
      via: "axios HTTP + WebSocket for progress"
      pattern: "api/v1/fusion"
---

<objective>
Iris Fusion and Composition -- Poisson blending for seamless iris fusion, OpenCV hconcat/vconcat for side-by-side compositions, consent verification gate, async Celery tasks with progress, and mobile builder screens.

Purpose: Deliver the core social art creation features (SOCL-04, SOCL-05). Users combine their irises with those of circle members to create unique fused or composed artwork, with explicit consent enforced.
Output: FusionArtwork model, fusion and composition Celery tasks, REST API, mobile builder and result screens.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-features-circles-and-fusion/05-RESEARCH.md
@.planning/phases/05-social-features-circles-and-fusion/05-01-SUMMARY.md
@.planning/phases/05-social-features-circles-and-fusion/05-02-SUMMARY.md
@.planning/phases/03-ai-processing-pipeline/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: FusionArtwork model, fusion/composition Celery tasks, fusion service, API routes, and migration</name>
  <files>
    backend/app/models/fusion_artwork.py
    backend/app/schemas/fusion.py
    backend/app/services/fusion_service.py
    backend/app/workers/tasks/fusion_blending.py
    backend/app/workers/tasks/composition.py
    backend/app/api/routes/fusion.py
    backend/app/models/__init__.py
    backend/app/models/user.py
    backend/app/main.py
    backend/alembic/versions/f6a7b8c9d0e1_add_fusion_artworks.py
  </files>
  <action>
    **FusionArtwork Model** (`backend/app/models/fusion_artwork.py`):
    - id: UUID PK (default uuid4)
    - creator_id: UUID FK to users.id ON DELETE CASCADE, indexed
    - circle_id: UUID FK to circles.id ON DELETE SET NULL, nullable (fusion can outlive circle)
    - source_artwork_ids: JSON column (list of photo UUIDs used in fusion)
    - fusion_type: String, not null -- "fusion" (Poisson blend) or "composition" (side-by-side)
    - blend_mode: String, nullable -- "poisson", "alpha" (for fusion), or "horizontal", "vertical", "grid_2x2" (for composition)
    - status: String, default "pending" -- "pending", "processing", "completed", "failed"
    - result_s3_key: String, nullable (S3 path for completed result)
    - thumbnail_s3_key: String, nullable (S3 path for 256px preview)
    - error_message: String, nullable
    - processing_time_ms: Integer, nullable
    - created_at: DateTime(timezone=True), server_default now
    - completed_at: DateTime(timezone=True), nullable
    - Relationships: creator (User), circle (Circle, nullable)

    Update `backend/app/models/__init__.py`: Import FusionArtwork.
    Update `backend/app/models/user.py`: Add `fusion_artworks` relationship.

    **Schemas** (`backend/app/schemas/fusion.py`):
    - FusionCreateRequest: artwork_ids (List[UUID], min 2, max 4), circle_id (Optional[UUID]), blend_mode (str, default "poisson").
    - CompositionCreateRequest: artwork_ids (List[UUID], min 2, max 4), circle_id (Optional[UUID]), layout (str -- "horizontal", "vertical", "grid_2x2").
    - FusionResponse: id, creator_id, fusion_type, blend_mode, status, result_url (presigned), thumbnail_url (presigned), source_artwork_ids, created_at, completed_at.
    - FusionStatusResponse: id, status, progress (int 0-100), current_step (str), result_url, thumbnail_url.

    **Fusion Blending Celery Task** (`backend/app/workers/tasks/fusion_blending.py`):
    - `create_fusion_artwork(artwork_ids: List[str], fusion_id: str, blend_mode: str = "poisson")`:
      Uses sync SQLAlchemy session (same pattern as Phase 3 processing tasks).
      1. Update FusionArtwork status to "processing" (progress 0%).
      2. Load source images from S3 (progress 10-20%). For each artwork_id, load the processed result image (result_s3_key from ProcessingJob or StyleJob -- use the best available: styled > processed). Also load segmentation masks (mask_s3_key from ProcessingJob).
      3. Resize all images to same dimensions: max 2048x2048. Use the largest source image dimensions as target (capped at 2048).
      4. Resize masks to match image dimensions.
      5. Apply Gaussian blur to mask edges (kernel=5) to smooth boundaries.
      6. Poisson blending loop (progress 30-80%): Start with first image as base. For each subsequent image, call `cv2.seamlessClone(src, dst, mask, center, cv2.MIXED_CLONE)`. If cv2.error occurs, fall back to alpha_blend_fallback.
      7. Generate thumbnail: resize result to 256x256, save as JPEG q70 to `fusion/{fusion_id}_thumb.jpg`.
      8. Save full result as JPEG q90 to `fusion/{fusion_id}.jpg` (progress 90%).
      9. Update FusionArtwork: status="completed", result_s3_key, thumbnail_s3_key, processing_time_ms, completed_at.
      10. WebSocket notification via same Celery state mechanism as Phase 3.
      - On failure: update status="failed" with error message.
      - Task config: bind=True, queue='default' (not high_priority -- fusion is less urgent), time_limit=180 (3 min max), soft_time_limit=150.
      - Memory guard: cap images at 2048x2048 to prevent OOM.

    - `alpha_blend_fallback(base, overlay, mask)`: Normalize mask to 0-1 float, expand to 3 channels if needed, blend: result = base * (1-alpha) + overlay * alpha.

    **Composition Task** (`backend/app/workers/tasks/composition.py`):
    - `create_composition(artwork_ids: List[str], fusion_id: str, layout: str = "horizontal")`:
      Uses sync SQLAlchemy session.
      1. Update FusionArtwork status to "processing".
      2. Load source images from S3 (same logic as fusion -- best available result).
      3. Determine target dimensions: for horizontal/vertical, use min height/width to avoid quality loss. For grid_2x2, use min of both.
      4. Resize all images to target dimensions.
      5. Layout:
         - "horizontal": `cv2.hconcat(images)` -- side by side
         - "vertical": `cv2.vconcat(images)` -- stacked
         - "grid_2x2": pad to 4 images with black if needed, hconcat pairs, vconcat rows
      6. Generate thumbnail (256px wide, proportional height).
      7. Save result and thumbnail to S3.
      8. Update FusionArtwork: status="completed", result_s3_key, thumbnail_s3_key, processing_time_ms.
      - Task config: queue='default', time_limit=60 (compositions are fast, <5s).

    **Fusion Service** (`backend/app/services/fusion_service.py`):
    - `submit_fusion(artwork_ids, creator_id, circle_id, blend_mode, db)`:
      1. Validate artwork_ids: 2-4 items, all photos exist and are processed (have a completed ProcessingJob or StyleJob).
      2. Check consent: call `check_all_consents_granted(artwork_ids, creator_id, "fusion", db)` from consent_service. If not all granted, return {status: "consent_required", pending: list of artwork_ids needing consent}.
      3. Create FusionArtwork record (fusion_type="fusion").
      4. Submit Celery task: `create_fusion_artwork.apply_async(args=[...], task_id=str(fusion.id))`.
      5. Return fusion record with WebSocket URL.

    - `submit_composition(artwork_ids, creator_id, circle_id, layout, db)`:
      Same as fusion but purpose="composition", fusion_type="composition". Checks consent with purpose="composition".

    - `get_fusion_status(fusion_id, user_id, db)`: Get FusionArtwork, verify creator or circle member. Return status with presigned URLs.

    - `get_user_fusions(user_id, db, offset=0, limit=20)`: List user's fusions with pagination.

    - `get_best_source_image(photo_id, db)`: Helper to find the best available processed image for a photo: first check for completed StyleJob result, then completed ProcessingJob result, then original photo. Returns S3 key.

    **API Routes** (`backend/app/api/routes/fusion.py`):
    - `POST /api/v1/fusion` -- Create fusion. Body: FusionCreateRequest. Returns FusionResponse or consent_required status.
    - `POST /api/v1/composition` -- Create composition. Body: CompositionCreateRequest. Returns FusionResponse or consent_required status.
    - `GET /api/v1/fusion/{fusion_id}` -- Fusion status with presigned URLs.
    - `GET /api/v1/fusion` -- List user's fusions. Query params: offset, limit.
    - `GET /api/v1/circles/{circle_id}/fusions` -- List fusions created in a circle context.

    Register fusion router in `backend/app/main.py`.

    **Migration:**
    Generate Alembic migration creating `fusion_artworks` table with JSON column for source_artwork_ids, proper foreign keys, and indexes.
  </action>
  <verify>
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.models.fusion_artwork import FusionArtwork; print('FusionArtwork OK')"`
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.workers.tasks.fusion_blending import create_fusion_artwork; from app.workers.tasks.composition import create_composition; print('Tasks OK')"`
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.api.routes.fusion import router; print('Fusion router OK')"`
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.services.fusion_service import submit_fusion, submit_composition; print('Fusion service OK')"`
    Verify cv2.seamlessClone import: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "import cv2; print(hasattr(cv2, 'seamlessClone'))"`
  </verify>
  <done>
    FusionArtwork model exists with fusion_type, blend_mode, and JSON source_artwork_ids. Fusion Celery task performs Poisson blending with alpha fallback, 2048px cap, and mask smoothing. Composition task handles horizontal/vertical/grid_2x2 layouts. Fusion service enforces consent check before submission. API endpoints registered. Migration creates fusion_artworks table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile fusion builder, composition builder, result screen, and navigation wiring</name>
  <files>
    mobile/src/types/fusion.ts
    mobile/src/services/fusion.ts
    mobile/src/hooks/useFusion.ts
    mobile/src/screens/Circles/FusionBuilderScreen.tsx
    mobile/src/screens/Circles/CompositionBuilderScreen.tsx
    mobile/src/screens/Circles/FusionResultScreen.tsx
    mobile/src/screens/Circles/SharedGalleryScreen.tsx
    mobile/src/navigation/CirclesNavigator.tsx
    mobile/src/navigation/types.ts
  </files>
  <action>
    **Types** (`mobile/src/types/fusion.ts`):
    - FusionArtwork: { id, creator_id, fusion_type, blend_mode, status, result_url, thumbnail_url, source_artwork_ids, created_at, completed_at }.
    - FusionSubmitResponse: { fusion_id, status, websocket_url } | { status: "consent_required", pending: ConsentStatus[] }.

    **API Service** (`mobile/src/services/fusion.ts`):
    - `createFusion(artworkIds, circleId, blendMode)` -- POST /api/v1/fusion
    - `createComposition(artworkIds, circleId, layout)` -- POST /api/v1/composition
    - `getFusionStatus(fusionId)` -- GET /api/v1/fusion/{fusionId}
    - `getUserFusions(offset, limit)` -- GET /api/v1/fusion

    **Hook** (`mobile/src/hooks/useFusion.ts`):
    - `useFusion(fusionId)`: Combines REST polling + WebSocket progress (reuse useJobProgress hook pattern from Phase 3). Returns { status, progress, currentStep, resultUrl, thumbnailUrl, error }.
    - Magical step names for fusion: "Gathering iris artworks...", "Preparing for blending...", "Creating seamless fusion...", "Adding finishing touches...", "Almost done..."
    - Magical step names for composition: "Arranging your irises...", "Creating layout...", "Saving composition..."

    **Screens:**

    `FusionBuilderScreen.tsx`:
    - Receives artworkIds and circleId from navigation params (from SharedGalleryScreen selection).
    - Shows preview thumbnails of selected artworks in a horizontal scroll.
    - Blend mode selector: "Seamless Blend" (poisson, default) and "Simple Blend" (alpha). Brief description under each: "Gradient-based blending for seamless results" / "Quick blend with transparency overlay".
    - "Create Fusion" button.
    - On submit: call createFusion. If response is "consent_required", show alert: "Consent needed from artwork owners. Requests have been sent." with list of pending consents. Navigate to CircleDetailScreen (consent notification will appear there).
    - If fusion submitted: navigate to FusionResultScreen with fusionId.
    - Show 2-4 artworks required validation (error if <2 or >4 selected).

    `CompositionBuilderScreen.tsx`:
    - Receives artworkIds and circleId from navigation params.
    - Shows preview thumbnails.
    - Layout selector with visual previews:
      - "Side by Side" (horizontal) -- shows [img1 | img2] icon
      - "Stacked" (vertical) -- shows img1 over img2 icon
      - "Grid" (grid_2x2) -- shows 2x2 grid icon (only enabled if 3-4 artworks selected)
    - "Create Composition" button.
    - Same consent handling as FusionBuilderScreen.
    - On success: navigate to FusionResultScreen with fusionId.

    `FusionResultScreen.tsx`:
    - Receives fusionId from navigation.
    - Uses useFusion hook for real-time progress.
    - While processing: show progress bar with magical step name. Show source artwork thumbnails below progress.
    - On completion: display result image full-width. Show source artworks as small row below.
    - Action buttons: "Save to Gallery" (using CameraRoll or RN Share), "Share" (RN Share API), "Back to Circle" (navigate to CircleDetailScreen).
    - On failure: show error message with "Try Again" button (re-submit same artworks).

    **Wire SharedGalleryScreen** (update from 05-02):
    - Update "Create Fusion" action button to navigate to FusionBuilderScreen with selected artworkIds and circleId.
    - Update "Side by Side" action button to navigate to CompositionBuilderScreen with selected artworkIds and circleId.
    - Show "Fusion" button only when 2-4 artworks selected.
    - Show "Side by Side" button only when 2-4 artworks selected.

    **Navigation** (update CirclesNavigator.tsx and types.ts):
    - Add FusionBuilder, CompositionBuilder, and FusionResult screens to CirclesNavigator stack.
    - Add param types: FusionBuilder needs { artworkIds: string[], circleId: string }, CompositionBuilder same, FusionResult needs { fusionId: string }.
  </action>
  <verify>
    Verify screen files exist:
    `ls mobile/src/screens/Circles/FusionBuilderScreen.tsx mobile/src/screens/Circles/CompositionBuilderScreen.tsx mobile/src/screens/Circles/FusionResultScreen.tsx`
    Verify hook and service:
    `ls mobile/src/hooks/useFusion.ts mobile/src/services/fusion.ts`
    Verify navigation wiring:
    `grep -l "FusionBuilder\|CompositionBuilder\|FusionResult" mobile/src/navigation/CirclesNavigator.tsx`
    Verify SharedGallery wiring:
    `grep -l "FusionBuilder\|CompositionBuilder" mobile/src/screens/Circles/SharedGalleryScreen.tsx`
  </verify>
  <done>
    FusionBuilderScreen allows blend mode selection and submits fusion with consent gate. CompositionBuilderScreen offers 3 layout options with visual previews. FusionResultScreen shows real-time progress with magical step names and displays completed result with save/share actions. SharedGalleryScreen wired to navigate to fusion/composition builders from artwork selection. All screens registered in CirclesNavigator.
  </done>
</task>

</tasks>

<verification>
- Backend: Fusion task calls cv2.seamlessClone for Poisson blending with alpha fallback
- Backend: Composition task produces correct layouts (horizontal, vertical, grid_2x2)
- Backend: Consent gate blocks fusion/composition if any non-self artwork lacks granted consent
- Backend: FusionArtwork stores source_artwork_ids as JSON, result as S3 key
- Mobile: FusionBuilder submits fusion and handles consent_required response
- Mobile: CompositionBuilder shows 3 layout options
- Mobile: FusionResult shows real-time progress and completed result
- Integration: Full flow from SharedGallery selection -> Builder -> Result works end-to-end
</verification>

<success_criteria>
- FusionArtwork model persists fusion/composition metadata including source artwork references
- Poisson blending (cv2.seamlessClone with MIXED_CLONE) produces seamless iris fusion, falls back to alpha blending on error
- Side-by-side composition supports 3 layouts (horizontal, vertical, grid_2x2) with dimension matching
- Consent verification blocks fusion/composition until all non-self consents are granted
- Fusion runs as Celery task with 3-minute timeout and WebSocket progress
- Images capped at 2048x2048 to prevent memory exhaustion
- Mask edges smoothed with Gaussian blur before Poisson blending
- Mobile shows builder screens with blend mode/layout selection and consent-aware submission
- Result screen displays real-time progress with magical step names and save/share actions
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-features-circles-and-fusion/05-03-SUMMARY.md`
</output>

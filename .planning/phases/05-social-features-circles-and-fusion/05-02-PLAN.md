---
phase: 05-social-features-circles-and-fusion
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - backend/app/models/artwork_consent.py
  - backend/app/schemas/consent.py
  - backend/app/services/consent_service.py
  - backend/app/api/routes/consent.py
  - backend/app/api/routes/circles.py
  - backend/app/services/circle_service.py
  - backend/app/models/__init__.py
  - backend/app/models/user.py
  - backend/app/main.py
  - backend/alembic/versions/e5f6a7b8c9d0_add_artwork_consents.py
  - mobile/src/types/consent.ts
  - mobile/src/services/consent.ts
  - mobile/src/screens/Circles/SharedGalleryScreen.tsx
  - mobile/src/screens/Circles/CircleDetailScreen.tsx
  - mobile/src/components/Circles/ConsentModal.tsx
  - mobile/src/components/Circles/ArtworkCard.tsx
  - mobile/src/hooks/useCircleGallery.ts
autonomous: true

must_haves:
  truths:
    - "Circle members can view a shared gallery containing all active members' processed iris art"
    - "Shared gallery excludes artwork from members who have left the circle"
    - "User can request consent from another member to use their artwork in fusion or composition"
    - "Artwork owner can grant or deny consent requests via in-app modal"
    - "User can revoke previously granted consent"
    - "Consent is per-artwork, per-grantee, per-purpose (fusion or composition)"
    - "Self-owned artwork has implicit consent (no request needed)"
  artifacts:
    - path: "backend/app/models/artwork_consent.py"
      provides: "ArtworkConsent model for per-artwork permission tracking"
      contains: "class ArtworkConsent"
    - path: "backend/app/services/consent_service.py"
      provides: "Consent request, grant, deny, revoke, and check operations"
      contains: "request_consent|check_consent|grant_consent"
    - path: "backend/app/api/routes/consent.py"
      provides: "Consent REST API endpoints"
      exports: ["router"]
    - path: "mobile/src/screens/Circles/SharedGalleryScreen.tsx"
      provides: "Cross-member gallery view for circle"
    - path: "mobile/src/components/Circles/ConsentModal.tsx"
      provides: "Consent approval/deny dialog"
  key_links:
    - from: "backend/app/api/routes/circles.py"
      to: "backend/app/services/circle_service.py"
      via: "get_shared_gallery endpoint"
      pattern: "get_shared_gallery"
    - from: "backend/app/services/consent_service.py"
      to: "backend/app/models/artwork_consent.py"
      via: "consent CRUD operations"
      pattern: "ArtworkConsent"
    - from: "mobile/src/hooks/useCircleGallery.ts"
      to: "/api/v1/circles/{circleId}/gallery"
      via: "axios HTTP call"
      pattern: "api/v1/circles.*gallery"
---

<objective>
Shared Galleries and Consent System -- Shared gallery API showing all active members' iris art, plus per-artwork consent model enabling explicit approval before art is used in fusion or compositions.

Purpose: Enable collaborative art viewing (SOCL-03) and establish the consent foundation (SOCL-06) required before fusion features. Users need to see shared art before they can select pieces for fusion.
Output: ArtworkConsent model, consent API, shared gallery endpoint, mobile gallery and consent UI.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-features-circles-and-fusion/05-RESEARCH.md
@.planning/phases/05-social-features-circles-and-fusion/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ArtworkConsent model, consent service, shared gallery service, API routes, and migration</name>
  <files>
    backend/app/models/artwork_consent.py
    backend/app/schemas/consent.py
    backend/app/services/consent_service.py
    backend/app/api/routes/consent.py
    backend/app/api/routes/circles.py
    backend/app/services/circle_service.py
    backend/app/models/__init__.py
    backend/app/models/user.py
    backend/app/main.py
    backend/alembic/versions/e5f6a7b8c9d0_add_artwork_consents.py
  </files>
  <action>
    **ArtworkConsent Model** (`backend/app/models/artwork_consent.py`):
    - id: UUID PK (default uuid4)
    - artwork_id: UUID FK to photos.id ON DELETE CASCADE, indexed
    - grantor_user_id: UUID FK to users.id ON DELETE CASCADE, indexed (the artwork owner who grants/denies)
    - grantee_user_id: UUID FK to users.id ON DELETE CASCADE, indexed (the person requesting to use the art)
    - circle_id: UUID FK to circles.id ON DELETE CASCADE, nullable (scoped to circle context)
    - purpose: String, not null -- "fusion" or "composition"
    - status: String, default "pending" -- "pending", "granted", "denied", "revoked"
    - requested_at: DateTime(timezone=True), server_default now
    - decided_at: DateTime(timezone=True), nullable
    - Relationships: artwork (Photo), grantor (User, foreign_keys=[grantor_user_id]), grantee (User, foreign_keys=[grantee_user_id]), circle (Circle, nullable)
    - UniqueConstraint("artwork_id", "grantee_user_id", "purpose", name="uq_consent_artwork_grantee_purpose") -- one consent per artwork+grantee+purpose combination

    Update `backend/app/models/__init__.py`: Import ArtworkConsent.
    Update `backend/app/models/user.py`: Add relationships for consent_grants and consent_requests.

    **Schemas** (`backend/app/schemas/consent.py`):
    - ConsentRequestCreate: artwork_ids (List[UUID], min 1, max 10), purpose (str, "fusion" or "composition"), circle_id (Optional[UUID]).
    - ConsentResponse: id, artwork_id, grantor_user_id, grantee_user_id, purpose, status, requested_at, decided_at.
    - ConsentDecision: status (str, "granted" or "denied").
    - PendingConsentResponse: id, artwork_id, artwork_preview_url, grantee_email, purpose, circle_name, requested_at.

    **Consent Service** (`backend/app/services/consent_service.py`):
    - `request_consent(artwork_ids, requester_id, purpose, circle_id, db)`:
      For each artwork: get photo, skip if requester owns it (self-consent implicit), check for existing granted consent (skip if already granted), check for existing pending consent (skip if pending), create new ArtworkConsent with status="pending". Return list of created consent requests.
    - `grant_consent(consent_id, grantor_id, db)`: Verify grantor owns the artwork. Set status="granted", decided_at=now(). Return updated consent.
    - `deny_consent(consent_id, grantor_id, db)`: Verify grantor owns the artwork. Set status="denied", decided_at=now().
    - `revoke_consent(consent_id, grantor_id, db)`: Only revoke if status="granted". Set status="revoked", decided_at=now().
    - `check_all_consents_granted(artwork_ids, requester_id, purpose, db)`: For each artwork not owned by requester, check that a consent with status="granted" exists. Return bool.
    - `get_pending_consents_for_user(user_id, db)`: Get all consents where grantor_user_id=user_id and status="pending". Include artwork preview URL (presigned). Return list of PendingConsentResponse.
    - `get_consent_status(artwork_ids, requester_id, purpose, db)`: For each artwork, return consent status (self, granted, pending, denied, none). Used by mobile to show consent state per artwork.

    **Shared Gallery** -- extend `backend/app/services/circle_service.py`:
    - `get_shared_gallery(circle_id, user_id, db, offset=0, limit=20)`:
      Verify active membership. Get all active member user_ids (left_at IS NULL). Query photos where user_id IN member_ids AND upload_status="processed", ordered by created_at DESC. Include style jobs (completed status) for each photo. Paginate with offset/limit. For each photo, generate presigned URL for thumbnail. Return list with owner info (user_id, email).

    **API Routes:**

    Extend `backend/app/api/routes/circles.py` -- add shared gallery endpoint:
    - `GET /api/v1/circles/{circle_id}/gallery?offset=0&limit=20` -- Shared gallery. Returns paginated list of member artworks with presigned thumbnail URLs and owner info.

    Create `backend/app/api/routes/consent.py`:
    - `POST /api/v1/consent/request` -- Request consent for artwork usage. Body: ConsentRequestCreate. Returns list of ConsentResponse (created consents) + list of already-granted artwork_ids.
    - `GET /api/v1/consent/pending` -- List pending consent requests for current user (as grantor). Returns List[PendingConsentResponse].
    - `POST /api/v1/consent/{consent_id}/decide` -- Grant or deny. Body: ConsentDecision. Returns ConsentResponse.
    - `POST /api/v1/consent/{consent_id}/revoke` -- Revoke granted consent. Returns ConsentResponse.
    - `GET /api/v1/consent/status?artwork_ids=...&purpose=fusion` -- Check consent status for multiple artworks. Returns dict of {artwork_id: status}.

    Register consent router in `backend/app/main.py`.

    **Migration:**
    Generate Alembic migration creating `artwork_consents` table with the unique constraint and all indexes.
  </action>
  <verify>
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.models.artwork_consent import ArtworkConsent; print('ArtworkConsent OK')"`
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.api.routes.consent import router; print('Consent router OK')"`
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.services.consent_service import request_consent, check_all_consents_granted; print('Consent service OK')"`
    Verify shared gallery route exists: `grep "gallery" backend/app/api/routes/circles.py`
  </verify>
  <done>
    ArtworkConsent model exists with per-artwork, per-grantee, per-purpose tracking. Consent service handles full lifecycle (request, grant, deny, revoke, check). Shared gallery endpoint returns paginated cross-member artwork with presigned URLs. Consent API registered in main.py. Migration creates artwork_consents table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile shared gallery screen, consent UI, and artwork card component</name>
  <files>
    mobile/src/types/consent.ts
    mobile/src/services/consent.ts
    mobile/src/screens/Circles/SharedGalleryScreen.tsx
    mobile/src/screens/Circles/CircleDetailScreen.tsx
    mobile/src/components/Circles/ConsentModal.tsx
    mobile/src/components/Circles/ArtworkCard.tsx
    mobile/src/hooks/useCircleGallery.ts
  </files>
  <action>
    **Types** (`mobile/src/types/consent.ts`):
    - ConsentRequest: { id, artwork_id, grantor_user_id, grantee_user_id, purpose, status, requested_at }.
    - PendingConsent: { id, artwork_id, artwork_preview_url, grantee_email, purpose, circle_name, requested_at }.
    - ConsentStatus: { artwork_id, status: 'self' | 'granted' | 'pending' | 'denied' | 'none' }.

    **API Service** (`mobile/src/services/consent.ts`):
    - `requestConsent(artworkIds, purpose, circleId)` -- POST /api/v1/consent/request
    - `getPendingConsents()` -- GET /api/v1/consent/pending
    - `decideConsent(consentId, decision)` -- POST /api/v1/consent/{consentId}/decide
    - `revokeConsent(consentId)` -- POST /api/v1/consent/{consentId}/revoke
    - `getConsentStatus(artworkIds, purpose)` -- GET /api/v1/consent/status

    **Hook** (`mobile/src/hooks/useCircleGallery.ts`):
    - `useCircleGallery(circleId)`: Fetches shared gallery with pagination (useInfiniteQuery or manual offset tracking). Returns { artworks, loading, error, loadMore, refresh }. Each artwork includes owner info and thumbnail URL.

    **Components:**

    `ArtworkCard.tsx`:
    - Displays artwork thumbnail with owner email/name badge at bottom.
    - Supports selection mode (checkmark overlay when selected, blue border).
    - Shows "Your Art" badge for self-owned artworks.
    - Props: artwork, isSelected, onPress, onLongPress, showOwner.
    - Use FastImage for image caching (same pattern as Phase 2 gallery).

    `ConsentModal.tsx`:
    - Modal dialog shown when user has pending consent requests.
    - Shows artwork thumbnail preview, requester email, purpose ("wants to use your iris art for fusion").
    - Two buttons: "Allow" (calls decideConsent with "granted") and "Deny" (calls decideConsent with "denied").
    - Swipeable list of pending consents if multiple.
    - Dismiss closes modal.
    - Badge count on CircleDetailScreen or tab bar to indicate pending consents.

    **Screens:**

    `SharedGalleryScreen.tsx`:
    - Receives circleId from navigation params.
    - Uses useCircleGallery hook for data.
    - FlashList 2-column grid of ArtworkCard components (same masonry pattern as Phase 2 gallery).
    - Each card shows artwork thumbnail + owner badge.
    - Selection mode: tap to select artworks (selection state managed locally). When 2+ artworks selected, show floating action buttons: "Create Fusion" and "Side by Side" (these navigate to FusionBuilder/CompositionBuilder screens -- placeholder navigations for 05-03).
    - Pull-to-refresh.
    - Empty state: "No artwork shared yet. Members' processed iris art appears here."
    - Header shows circle name and member count.

    Update `CircleDetailScreen.tsx` (from 05-01):
    - Wire "Shared Gallery" button to navigate to SharedGalleryScreen with circleId.
    - Add consent notification badge: fetch pending consents count, show red badge on a "Consent Requests" button/icon if count > 0. Tapping opens ConsentModal.
  </action>
  <verify>
    Verify screen files exist:
    `ls mobile/src/screens/Circles/SharedGalleryScreen.tsx mobile/src/components/Circles/ConsentModal.tsx mobile/src/components/Circles/ArtworkCard.tsx`
    Verify hook exists:
    `ls mobile/src/hooks/useCircleGallery.ts`
    Verify consent service:
    `ls mobile/src/services/consent.ts`
    Verify CircleDetail updated:
    `grep -l "SharedGallery\|ConsentModal" mobile/src/screens/Circles/CircleDetailScreen.tsx`
  </verify>
  <done>
    SharedGalleryScreen displays all active members' artwork in 2-column grid with owner badges. ArtworkCard supports selection mode for future fusion/composition. ConsentModal shows pending consent requests with allow/deny buttons. CircleDetailScreen links to shared gallery and shows consent notification badge. Selection of 2+ artworks reveals fusion/composition action buttons.
  </done>
</task>

</tasks>

<verification>
- Backend: Shared gallery returns artwork from all active circle members only (excludes left members)
- Backend: Consent request creates pending records, grant/deny updates status with timestamp
- Backend: check_all_consents_granted returns true only when all non-self artworks have granted consent
- Mobile: SharedGallery renders 2-column grid with owner badges
- Mobile: ConsentModal correctly shows pending requests and sends grant/deny decisions
- Integration: Shared gallery API returns paginated results with presigned URLs
</verification>

<success_criteria>
- Shared gallery endpoint returns artwork from active members with presigned URLs, paginated
- ArtworkConsent model tracks per-artwork, per-grantee, per-purpose consent with full lifecycle
- Consent request creates pending consents for non-self artworks, skips self-owned
- Grant/deny/revoke operations work with proper authorization (only grantor can decide)
- check_all_consents_granted returns accurate boolean for fusion gate
- Mobile shared gallery shows 2-column grid with owner identification
- ConsentModal enables approve/deny flow for artwork usage requests
- Consent notification badge shows count of pending requests
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-features-circles-and-fusion/05-02-SUMMARY.md`
</output>

---
phase: 05-social-features-circles-and-fusion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/src/types/circles.ts
  - mobile/src/services/circles.ts
  - mobile/src/services/invites.ts
  - mobile/src/store/circleStore.ts
  - mobile/src/screens/Circles/CirclesListScreen.tsx
  - mobile/src/screens/Circles/CreateCircleScreen.tsx
  - mobile/src/screens/Circles/CircleDetailScreen.tsx
  - mobile/src/screens/Circles/InviteScreen.tsx
  - mobile/src/screens/Circles/JoinCircleScreen.tsx
  - mobile/src/navigation/CirclesNavigator.tsx
  - mobile/src/navigation/types.ts
  - mobile/src/navigation/RootNavigator.tsx
autonomous: true

must_haves:
  truths:
    - "User can browse their circles in a list with member count and role badge"
    - "User can create a new named circle from a form screen"
    - "User can view circle detail with member list and management actions"
    - "User can generate and share an invite link for a circle"
    - "User can accept an invite via deep link and join a circle"
    - "Navigation integrates circles into the main app flow"
  artifacts:
    - path: "mobile/src/screens/Circles/CirclesListScreen.tsx"
      provides: "Circle browsing screen"
    - path: "mobile/src/screens/Circles/JoinCircleScreen.tsx"
      provides: "Invite acceptance screen"
    - path: "mobile/src/navigation/CirclesNavigator.tsx"
      provides: "Circles stack navigator"
    - path: "mobile/src/store/circleStore.ts"
      provides: "Zustand store for circles"
  key_links:
    - from: "mobile/src/services/circles.ts"
      to: "/api/v1/circles"
      via: "axios HTTP calls"
      pattern: "api/v1/circles"
    - from: "mobile/src/services/invites.ts"
      to: "/api/v1/invites"
      via: "axios HTTP calls"
      pattern: "api/v1/invites"
    - from: "mobile/src/navigation/RootNavigator.tsx"
      to: "mobile/src/navigation/CirclesNavigator.tsx"
      via: "tab or drawer entry"
      pattern: "CirclesNavigator"
---

<objective>
Circles Mobile -- Types, API services, Zustand store, screens, and navigation for browsing circles, creating circles, viewing members, generating invite links, and joining via deep link.

Purpose: Provide the mobile user interface for the social circle features. Users interact with circles through these screens.
Output: Circle screens (list, create, detail, invite, join), navigation integration, API services, Zustand store.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-features-circles-and-fusion/05-RESEARCH.md
@.planning/phases/05-social-features-circles-and-fusion/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types, API services, and Zustand store</name>
  <files>
    mobile/src/types/circles.ts
    mobile/src/services/circles.ts
    mobile/src/services/invites.ts
    mobile/src/store/circleStore.ts
  </files>
  <action>
    **Types** (`mobile/src/types/circles.ts`):
    - Circle: { id, name, role, member_count, created_at }.
    - CircleMember: { user_id, email, role, joined_at }.
    - InviteInfo: { circle_name, inviter_email, expires_in_days }.
    - InviteResponse: { invite_url, token, expires_in_days }.

    **API Services:**

    Create `mobile/src/services/circles.ts`:
    - `getCircles()` -- GET /api/v1/circles
    - `createCircle(name)` -- POST /api/v1/circles
    - `getCircleDetail(circleId)` -- GET /api/v1/circles/{circleId}
    - `getCircleMembers(circleId)` -- GET /api/v1/circles/{circleId}/members
    - `leaveCircle(circleId)` -- POST /api/v1/circles/{circleId}/leave
    - `removeMember(circleId, userId)` -- DELETE /api/v1/circles/{circleId}/members/{userId}

    Create `mobile/src/services/invites.ts`:
    - `createInvite(circleId)` -- POST /api/v1/circles/{circleId}/invite
    - `getInviteInfo(token)` -- GET /api/v1/invites/{token}/info
    - `acceptInvite(token)` -- POST /api/v1/invites/{token}/accept

    All services use the existing axios instance with JWT interceptor from Phase 2.

    **Store** (`mobile/src/store/circleStore.ts`):
    Zustand store (same pattern as upload/processing stores):
    - `circles: Circle[]`
    - `loading: boolean`
    - `fetchCircles()` -- calls getCircles(), updates state
    - `addCircle(circle)` -- optimistic add after creation
    - `removeCircle(circleId)` -- remove from local state after leaving
  </action>
  <verify>
    Verify files exist:
    `ls mobile/src/types/circles.ts mobile/src/services/circles.ts mobile/src/services/invites.ts mobile/src/store/circleStore.ts`
  </verify>
  <done>
    Types define Circle, CircleMember, InviteInfo, InviteResponse. API services call all circle and invite endpoints using existing axios instance. Zustand store manages circles state with fetch, add, and remove operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Circle screens and navigation integration</name>
  <files>
    mobile/src/screens/Circles/CirclesListScreen.tsx
    mobile/src/screens/Circles/CreateCircleScreen.tsx
    mobile/src/screens/Circles/CircleDetailScreen.tsx
    mobile/src/screens/Circles/InviteScreen.tsx
    mobile/src/screens/Circles/JoinCircleScreen.tsx
    mobile/src/navigation/CirclesNavigator.tsx
    mobile/src/navigation/types.ts
    mobile/src/navigation/RootNavigator.tsx
  </files>
  <action>
    **Screens:**

    `CirclesListScreen.tsx`:
    - FlatList of user's circles. Each row shows circle name, member count, role badge (owner/member).
    - Pull-to-refresh. Empty state: "No circles yet. Create one to share iris art with friends and family."
    - FAB (floating action button) to navigate to CreateCircleScreen.
    - Tap a circle navigates to CircleDetailScreen.

    `CreateCircleScreen.tsx`:
    - TextInput for circle name (max 50 chars, placeholder "e.g., Family, Couple, Friends").
    - "Create Circle" button. On success, navigate to CircleDetailScreen.
    - Show error if name empty or API returns error.

    `CircleDetailScreen.tsx`:
    - Header: Circle name, member count.
    - Member list (FlatList): Each member shows email, role badge, joined date.
    - If current user is owner: long-press on member shows "Remove" option (with confirmation Alert).
    - Buttons: "Invite Members" (navigates to InviteScreen), "Shared Gallery" (disabled placeholder button with "Coming soon" toast -- gallery screen is built in 05-04), "Leave Circle" (confirmation alert, calls leaveCircle, navigates back to list).
    - If owner is last member and taps "Leave", show "This will delete the circle" warning.

    `InviteScreen.tsx`:
    - On mount, call createInvite(circleId) to generate invite link.
    - Display invite URL in a copyable text field.
    - "Copy Link" button using Clipboard.setString (from @react-native-clipboard/clipboard -- if not installed, use RN's built-in Clipboard which is deprecated but functional).
    - "Share" button using React Native's built-in Share API (Share.share). Share message: "Join my IrisVue circle! {invite_url}".
    - Show expiry info: "This link expires in 7 days".

    `JoinCircleScreen.tsx`:
    - Receives `token` param from deep link or navigation.
    - On mount, call getInviteInfo(token) to preview circle name and inviter.
    - Show circle name, inviter email, "Join Circle" button.
    - On join: call acceptInvite(token), show success toast, navigate to CircleDetailScreen.
    - Handle errors: expired link, already member, circle full (10 members).

    **Navigation:**

    Create `mobile/src/navigation/CirclesNavigator.tsx`:
    - Stack navigator with screens: CirclesList, CreateCircle, CircleDetail, Invite, JoinCircle.
    - Include placeholder screen definitions for SharedGallery, FusionBuilder, CompositionBuilder, FusionResult (will be added in 05-04 and 05-06) -- register the names so navigation types are ready, but the actual screen components will be added later.

    Update `mobile/src/navigation/types.ts`:
    - Add CirclesStack param list types.
    - Add JoinCircle route with token param (for deep link).
    - Add placeholder types for SharedGallery (circleId), FusionBuilder (artworkIds, circleId), CompositionBuilder (artworkIds, circleId), FusionResult (fusionId) -- ready for later plans.

    Update `mobile/src/navigation/RootNavigator.tsx`:
    - Add CirclesNavigator as a tab or drawer entry (matching existing navigation pattern).
    - Add deep link configuration for invite URLs: path "invite/:token" maps to JoinCircle screen.
    - For deep linking, use React Navigation's linking config (not Branch.io -- use simple React Navigation linking for MVP).
  </action>
  <verify>
    Verify all screen files exist:
    `ls mobile/src/screens/Circles/CirclesListScreen.tsx mobile/src/screens/Circles/CreateCircleScreen.tsx mobile/src/screens/Circles/CircleDetailScreen.tsx mobile/src/screens/Circles/InviteScreen.tsx mobile/src/screens/Circles/JoinCircleScreen.tsx`
    Verify navigation files updated:
    `grep -l "CirclesNavigator" mobile/src/navigation/RootNavigator.tsx`
  </verify>
  <done>
    Mobile circle management flow complete: user can browse circles, create a new circle, view circle detail with members, generate and share invite links, accept invites via deep link. Navigation integrates into main app flow. "Shared Gallery" button is a placeholder (disabled with "Coming soon" toast) until 05-04 wires it to the gallery screen. Navigation types include forward-references for gallery/fusion screens.
  </done>
</task>

</tasks>

<verification>
- Mobile: All screens render, navigation works between circle screens, API services call correct endpoints
- CirclesList shows user's circles with member count and role badges
- CreateCircle creates and navigates to detail
- CircleDetail shows members, invite button, placeholder gallery button, leave button
- InviteScreen generates and shares invite link
- JoinCircleScreen previews and accepts invite
</verification>

<success_criteria>
- Mobile shows circle list, create, detail, invite, and join screens
- Deep link configuration routes invite URLs to JoinCircle screen
- Zustand store tracks circles locally with fetch/add/remove
- "Shared Gallery" button exists as disabled placeholder (wired in 05-04)
- Navigation types include forward-references for future screens
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-features-circles-and-fusion/05-02-SUMMARY.md`
</output>

---
phase: 05-social-features-circles-and-fusion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/circle.py
  - backend/app/models/circle_membership.py
  - backend/app/schemas/circles.py
  - backend/app/services/circle_service.py
  - backend/app/services/invite_service.py
  - backend/app/api/routes/circles.py
  - backend/app/api/routes/invites.py
  - backend/app/main.py
  - backend/app/models/__init__.py
  - backend/app/models/user.py
  - backend/alembic/versions/d4e5f6a7b8c9_add_circles_and_circle_memberships.py
  - mobile/src/types/circles.ts
  - mobile/src/services/circles.ts
  - mobile/src/services/invites.ts
  - mobile/src/store/circleStore.ts
  - mobile/src/screens/Circles/CirclesListScreen.tsx
  - mobile/src/screens/Circles/CreateCircleScreen.tsx
  - mobile/src/screens/Circles/CircleDetailScreen.tsx
  - mobile/src/screens/Circles/InviteScreen.tsx
  - mobile/src/screens/Circles/JoinCircleScreen.tsx
  - mobile/src/navigation/CirclesNavigator.tsx
  - mobile/src/navigation/types.ts
  - mobile/src/navigation/RootNavigator.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a named circle (couple, family, friends) with max 50 character name"
    - "User can generate a shareable invite link for their circle"
    - "Recipient can accept an invite link and join the circle as a member"
    - "Circle owner can view all members of a circle"
    - "User can leave a circle (soft delete with left_at timestamp)"
    - "Circle owner can remove a member from a circle"
    - "Invite links expire after 7 days and cannot be reused"
    - "Circle has a 10-member limit"
  artifacts:
    - path: "backend/app/models/circle.py"
      provides: "Circle SQLAlchemy model"
      contains: "class Circle"
    - path: "backend/app/models/circle_membership.py"
      provides: "CircleMembership join table with roles and soft delete"
      contains: "class CircleMembership"
    - path: "backend/app/services/invite_service.py"
      provides: "itsdangerous token generation and validation"
      contains: "URLSafeTimedSerializer"
    - path: "backend/app/api/routes/circles.py"
      provides: "Circle CRUD REST endpoints"
      exports: ["router"]
    - path: "backend/app/api/routes/invites.py"
      provides: "Invite generation and acceptance endpoints"
      exports: ["router"]
    - path: "mobile/src/screens/Circles/CirclesListScreen.tsx"
      provides: "Circle browsing screen"
    - path: "mobile/src/screens/Circles/JoinCircleScreen.tsx"
      provides: "Invite acceptance screen"
  key_links:
    - from: "backend/app/api/routes/invites.py"
      to: "backend/app/services/invite_service.py"
      via: "generate_invite_token and validate_invite_token"
      pattern: "generate_invite_token|validate_invite_token"
    - from: "backend/app/api/routes/circles.py"
      to: "backend/app/services/circle_service.py"
      via: "circle CRUD operations"
      pattern: "create_circle|get_user_circles|leave_circle|remove_member"
    - from: "mobile/src/services/circles.ts"
      to: "/api/v1/circles"
      via: "axios HTTP calls"
      pattern: "api/v1/circles"
---

<objective>
Circles CRUD and Invitations -- Backend models, services, API, and mobile screens for creating named circles, inviting members via shareable links, and managing membership (join, leave, remove).

Purpose: Establish the social layer foundation. Circles are the organizing entity for all subsequent shared gallery and fusion features.
Output: Circle and CircleMembership models, invite token system, circle management API, mobile circle screens with navigation.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-features-circles-and-fusion/05-RESEARCH.md
@.planning/phases/01-foundation-and-privacy-architecture/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Circle and CircleMembership models, services, API routes, and migration</name>
  <files>
    backend/app/models/circle.py
    backend/app/models/circle_membership.py
    backend/app/schemas/circles.py
    backend/app/services/circle_service.py
    backend/app/services/invite_service.py
    backend/app/api/routes/circles.py
    backend/app/api/routes/invites.py
    backend/app/main.py
    backend/app/models/__init__.py
    backend/app/models/user.py
    backend/alembic/versions/d4e5f6a7b8c9_add_circles_and_circle_memberships.py
  </files>
  <action>
    **Models:**

    Create `backend/app/models/circle.py`:
    - Circle model: id (UUID PK, default uuid4), name (String, max 50, not null), created_by (UUID FK to users.id ON DELETE CASCADE), created_at (DateTime timezone, server_default now).
    - Relationships: `memberships` (back_populates "circle", cascade "all, delete-orphan"), `creator` (User, foreign_keys=[created_by]).

    Create `backend/app/models/circle_membership.py`:
    - CircleMembership model: id (UUID PK), circle_id (UUID FK circles.id ON DELETE CASCADE, index), user_id (UUID FK users.id ON DELETE CASCADE, index), role (String, default "member" -- values: "owner", "member"), joined_at (DateTime timezone, server_default now), left_at (DateTime timezone, nullable -- soft delete).
    - UniqueConstraint("circle_id", "user_id", name="uq_circle_user").
    - Relationships: circle (back_populates "memberships"), user (User).

    Update `backend/app/models/user.py`: Add `circle_memberships` relationship (back_populates="user").
    Update `backend/app/models/__init__.py`: Import Circle and CircleMembership.

    **Schemas** (`backend/app/schemas/circles.py`):
    - CircleCreateRequest: name (str, min 1, max 50).
    - CircleResponse: id, name, role, member_count, created_at.
    - CircleMemberResponse: user_id, email, role, joined_at.
    - InviteCreateResponse: invite_url, token, expires_in_days.
    - InviteAcceptRequest: token (str).

    **Services:**

    Create `backend/app/services/circle_service.py`:
    - `create_circle(name, user_id, db)`: Create circle + add creator as owner member. Validate user isn't in >20 circles already.
    - `get_user_circles(user_id, db)`: List circles where user is active member (left_at IS NULL). Include member count.
    - `get_circle_detail(circle_id, user_id, db)`: Get circle with membership check. Return circle info + members list.
    - `get_circle_members(circle_id, user_id, db)`: List active members. Verify requester is active member first.
    - `leave_circle(circle_id, user_id, db)`: Soft delete -- set left_at=now(). If owner leaving: if other members exist, transfer ownership to oldest member; if no other members, hard delete the circle.
    - `remove_member(circle_id, owner_id, target_user_id, db)`: Owner-only. Verify owner role. Set target's left_at=now(). Cannot remove self (use leave_circle).
    - `verify_active_membership(circle_id, user_id, db)`: Helper that returns CircleMembership or raises 403. Used by other services.

    Create `backend/app/services/invite_service.py`:
    - Use `itsdangerous.URLSafeTimedSerializer` with `settings.SECRET_KEY` and salt "circle-invite".
    - `generate_invite_token(circle_id, inviter_id)`: Serialize payload {circle_id, inviter_id}. Return token string.
    - `validate_invite_token(token, max_age=604800)`: Deserialize with 7-day max age. Check Redis key `used_invite:{token}` for replay prevention. Returns payload dict or raises ValueError with message.
    - `mark_token_used(token, redis)`: Set Redis key `used_invite:{token}` with 30-day TTL.
    - `accept_invite(token, user_id, db, redis)`: Validate token, check circle exists, check not already member (if soft-deleted, check if removed by owner vs self-leave -- only block rejoining if removed by owner), check circle has <10 members, create CircleMembership, mark token used. Return circle info.

    **API Routes:**

    Create `backend/app/api/routes/circles.py`:
    - `POST /api/v1/circles` -- Create circle. Returns CircleResponse.
    - `GET /api/v1/circles` -- List user's circles. Returns List[CircleResponse].
    - `GET /api/v1/circles/{circle_id}` -- Circle detail with members. Requires membership.
    - `GET /api/v1/circles/{circle_id}/members` -- List active members.
    - `POST /api/v1/circles/{circle_id}/leave` -- Leave circle (soft delete).
    - `DELETE /api/v1/circles/{circle_id}/members/{user_id}` -- Remove member (owner only).

    Create `backend/app/api/routes/invites.py`:
    - `POST /api/v1/circles/{circle_id}/invite` -- Generate invite. Requires active membership. Rate limit: 5 per circle per hour (check Redis counter).
    - `POST /api/v1/invites/{token}/accept` -- Accept invite and join circle.
    - `GET /api/v1/invites/{token}/info` -- Get circle name and inviter info from token without joining (for preview on mobile).

    Register both routers in `backend/app/main.py` under `/api/v1`.

    **Migration:**
    Generate Alembic migration creating `circles` and `circle_memberships` tables. Use the naming convention from existing migrations. Include the unique constraint and indexes.
  </action>
  <verify>
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.models.circle import Circle; from app.models.circle_membership import CircleMembership; print('Models OK')"`
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.api.routes.circles import router; from app.api.routes.invites import router; print('Routes OK')"`
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.services.circle_service import create_circle, leave_circle; from app.services.invite_service import generate_invite_token, validate_invite_token; print('Services OK')"`
    Verify migration file exists in alembic/versions/.
  </verify>
  <done>
    Circle and CircleMembership models exist with proper relationships and constraints. Circle CRUD API returns correct responses. Invite token generation uses itsdangerous with 7-day expiry. Accept invite creates membership with replay prevention via Redis. Leave circle soft-deletes membership. Owner can remove members. Circle has 10-member limit. Rate limiting on invite generation (5/hour/circle).
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile circle screens, navigation, and invite flow</name>
  <files>
    mobile/src/types/circles.ts
    mobile/src/services/circles.ts
    mobile/src/services/invites.ts
    mobile/src/store/circleStore.ts
    mobile/src/screens/Circles/CirclesListScreen.tsx
    mobile/src/screens/Circles/CreateCircleScreen.tsx
    mobile/src/screens/Circles/CircleDetailScreen.tsx
    mobile/src/screens/Circles/InviteScreen.tsx
    mobile/src/screens/Circles/JoinCircleScreen.tsx
    mobile/src/navigation/CirclesNavigator.tsx
    mobile/src/navigation/types.ts
    mobile/src/navigation/RootNavigator.tsx
  </files>
  <action>
    **Types** (`mobile/src/types/circles.ts`):
    - Circle: { id, name, role, member_count, created_at }.
    - CircleMember: { user_id, email, role, joined_at }.
    - InviteInfo: { circle_name, inviter_email, expires_in_days }.
    - InviteResponse: { invite_url, token, expires_in_days }.

    **API Services:**

    Create `mobile/src/services/circles.ts`:
    - `getCircles()` -- GET /api/v1/circles
    - `createCircle(name)` -- POST /api/v1/circles
    - `getCircleDetail(circleId)` -- GET /api/v1/circles/{circleId}
    - `getCircleMembers(circleId)` -- GET /api/v1/circles/{circleId}/members
    - `leaveCircle(circleId)` -- POST /api/v1/circles/{circleId}/leave
    - `removeMember(circleId, userId)` -- DELETE /api/v1/circles/{circleId}/members/{userId}

    Create `mobile/src/services/invites.ts`:
    - `createInvite(circleId)` -- POST /api/v1/circles/{circleId}/invite
    - `getInviteInfo(token)` -- GET /api/v1/invites/{token}/info
    - `acceptInvite(token)` -- POST /api/v1/invites/{token}/accept

    All services use the existing axios instance with JWT interceptor from Phase 2.

    **Store** (`mobile/src/store/circleStore.ts`):
    Zustand store (same pattern as upload/processing stores):
    - `circles: Circle[]`
    - `loading: boolean`
    - `fetchCircles()` -- calls getCircles(), updates state
    - `addCircle(circle)` -- optimistic add after creation
    - `removeCircle(circleId)` -- remove from local state after leaving

    **Screens:**

    `CirclesListScreen.tsx`:
    - FlatList of user's circles. Each row shows circle name, member count, role badge (owner/member).
    - Pull-to-refresh. Empty state: "No circles yet. Create one to share iris art with friends and family."
    - FAB (floating action button) to navigate to CreateCircleScreen.
    - Tap a circle navigates to CircleDetailScreen.

    `CreateCircleScreen.tsx`:
    - TextInput for circle name (max 50 chars, placeholder "e.g., Family, Couple, Friends").
    - "Create Circle" button. On success, navigate to CircleDetailScreen.
    - Show error if name empty or API returns error.

    `CircleDetailScreen.tsx`:
    - Header: Circle name, member count.
    - Member list (FlatList): Each member shows email, role badge, joined date.
    - If current user is owner: long-press on member shows "Remove" option (with confirmation Alert).
    - Buttons: "Invite Members" (navigates to InviteScreen), "Shared Gallery" (navigates to SharedGalleryScreen -- placeholder for 05-02), "Leave Circle" (confirmation alert, calls leaveCircle, navigates back to list).
    - If owner is last member and taps "Leave", show "This will delete the circle" warning.

    `InviteScreen.tsx`:
    - On mount, call createInvite(circleId) to generate invite link.
    - Display invite URL in a copyable text field.
    - "Copy Link" button using Clipboard.setString (from @react-native-clipboard/clipboard -- if not installed, use RN's built-in Clipboard which is deprecated but functional).
    - "Share" button using react-native-share (Share.open) if installed, otherwise fall back to React Native's built-in Share API (Share.share). Share message: "Join my IrisVue circle! {invite_url}".
    - Show expiry info: "This link expires in 7 days".

    `JoinCircleScreen.tsx`:
    - Receives `token` param from deep link or navigation.
    - On mount, call getInviteInfo(token) to preview circle name and inviter.
    - Show circle name, inviter email, "Join Circle" button.
    - On join: call acceptInvite(token), show success toast, navigate to CircleDetailScreen.
    - Handle errors: expired link, already member, circle full (10 members).

    **Navigation:**

    Create `mobile/src/navigation/CirclesNavigator.tsx`:
    - Stack navigator with screens: CirclesList, CreateCircle, CircleDetail, Invite, JoinCircle.
    - SharedGallery, FusionBuilder placeholders (will be added in 05-02 and 05-03).

    Update `mobile/src/navigation/types.ts`:
    - Add CirclesStack param list types.
    - Add JoinCircle route with token param (for deep link).

    Update `mobile/src/navigation/RootNavigator.tsx`:
    - Add CirclesNavigator as a tab or drawer entry (matching existing navigation pattern).
    - Add deep link configuration for invite URLs: path "invite/:token" maps to JoinCircle screen.
    - For deep linking, use React Navigation's linking config (not Branch.io yet -- Branch.io is a new dependency that adds complexity; use simple React Navigation linking for MVP, can upgrade to Branch.io later if deferred deep links are needed).
  </action>
  <verify>
    Verify all screen files exist:
    `ls mobile/src/screens/Circles/CirclesListScreen.tsx mobile/src/screens/Circles/CreateCircleScreen.tsx mobile/src/screens/Circles/CircleDetailScreen.tsx mobile/src/screens/Circles/InviteScreen.tsx mobile/src/screens/Circles/JoinCircleScreen.tsx`
    Verify navigation files updated:
    `grep -l "CirclesNavigator" mobile/src/navigation/RootNavigator.tsx`
    Verify services exist:
    `ls mobile/src/services/circles.ts mobile/src/services/invites.ts`
  </verify>
  <done>
    Mobile circle management flow complete: user can browse circles, create a new circle, view circle detail with members, generate and share invite links, accept invites via deep link. Navigation integrates into main app flow. Zustand store tracks circles locally.
  </done>
</task>

</tasks>

<verification>
- Backend: All model imports succeed, API routes registered in main.py, Alembic migration creates tables
- Mobile: All screens render, navigation works between circle screens, API services call correct endpoints
- Integration: Create circle API returns CircleResponse, invite token generates and validates, accept invite creates membership
</verification>

<success_criteria>
- Circle model and CircleMembership model exist with UUID PKs, proper FK relationships, and soft delete (left_at)
- 6 circle API endpoints return correct JSON responses
- 3 invite API endpoints handle token generation, preview, and acceptance
- Invite tokens expire after 7 days, single-use enforced via Redis
- Mobile shows circle list, create, detail, invite, and join screens
- Deep link configuration routes invite URLs to JoinCircle screen
- 10-member limit enforced on circle join
- Owner can remove members, ownership transfers on owner departure
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-features-circles-and-fusion/05-01-SUMMARY.md`
</output>

---
phase: 05-social-features-circles-and-fusion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/circle.py
  - backend/app/models/circle_membership.py
  - backend/app/schemas/circles.py
  - backend/app/services/circle_service.py
  - backend/app/services/invite_service.py
  - backend/app/api/routes/circles.py
  - backend/app/api/routes/invites.py
  - backend/app/main.py
  - backend/app/models/__init__.py
  - backend/app/models/user.py
  - backend/alembic/versions/d4e5f6a7b8c9_add_circles_and_circle_memberships.py
autonomous: true

must_haves:
  truths:
    - "Circle and CircleMembership models exist with UUID PKs, soft delete, and 10-member limit"
    - "Circle CRUD API (create, list, detail, members, leave, remove) returns correct responses"
    - "Invite token generation uses itsdangerous with 7-day expiry and single-use Redis tracking"
    - "Accept invite creates membership with replay prevention"
    - "Owner can remove members; ownership transfers on owner departure"
  artifacts:
    - path: "backend/app/models/circle.py"
      provides: "Circle SQLAlchemy model"
      contains: "class Circle"
    - path: "backend/app/models/circle_membership.py"
      provides: "CircleMembership join table with roles and soft delete"
      contains: "class CircleMembership"
    - path: "backend/app/services/invite_service.py"
      provides: "itsdangerous token generation and validation"
      contains: "URLSafeTimedSerializer"
    - path: "backend/app/api/routes/circles.py"
      provides: "Circle CRUD REST endpoints"
      exports: ["router"]
    - path: "backend/app/api/routes/invites.py"
      provides: "Invite generation and acceptance endpoints"
      exports: ["router"]
  key_links:
    - from: "backend/app/api/routes/invites.py"
      to: "backend/app/services/invite_service.py"
      via: "generate_invite_token and validate_invite_token"
      pattern: "generate_invite_token|validate_invite_token"
    - from: "backend/app/api/routes/circles.py"
      to: "backend/app/services/circle_service.py"
      via: "circle CRUD operations"
      pattern: "create_circle|get_user_circles|leave_circle|remove_member"
---

<objective>
Circles Backend -- Models, services, API routes, and migration for creating named circles, inviting members via shareable links, and managing membership (join, leave, remove).

Purpose: Establish the social layer backend foundation. Circles are the organizing entity for all subsequent shared gallery and fusion features.
Output: Circle and CircleMembership models, invite token system, circle management API, Alembic migration.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-social-features-circles-and-fusion/05-RESEARCH.md
@.planning/phases/01-foundation-and-privacy-architecture/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Circle and CircleMembership models, schemas, and migration</name>
  <files>
    backend/app/models/circle.py
    backend/app/models/circle_membership.py
    backend/app/schemas/circles.py
    backend/app/models/__init__.py
    backend/app/models/user.py
    backend/alembic/versions/d4e5f6a7b8c9_add_circles_and_circle_memberships.py
  </files>
  <action>
    **Models:**

    Create `backend/app/models/circle.py`:
    - Circle model: id (UUID PK, default uuid4), name (String, max 50, not null), created_by (UUID FK to users.id ON DELETE CASCADE), created_at (DateTime timezone, server_default now).
    - Relationships: `memberships` (back_populates "circle", cascade "all, delete-orphan"), `creator` (User, foreign_keys=[created_by]).

    Create `backend/app/models/circle_membership.py`:
    - CircleMembership model: id (UUID PK), circle_id (UUID FK circles.id ON DELETE CASCADE, index), user_id (UUID FK users.id ON DELETE CASCADE, index), role (String, default "member" -- values: "owner", "member"), joined_at (DateTime timezone, server_default now), left_at (DateTime timezone, nullable -- soft delete).
    - UniqueConstraint("circle_id", "user_id", name="uq_circle_user").
    - Relationships: circle (back_populates "memberships"), user (User).

    Update `backend/app/models/user.py`: Add `circle_memberships` relationship (back_populates="user").
    Update `backend/app/models/__init__.py`: Import Circle and CircleMembership.

    **Schemas** (`backend/app/schemas/circles.py`):
    - CircleCreateRequest: name (str, min 1, max 50).
    - CircleResponse: id, name, role, member_count, created_at.
    - CircleMemberResponse: user_id, email, role, joined_at.
    - InviteCreateResponse: invite_url, token, expires_in_days.
    - InviteAcceptRequest: token (str).

    **Migration:**
    Generate Alembic migration creating `circles` and `circle_memberships` tables. Use the naming convention from existing migrations. Include the unique constraint and indexes.
  </action>
  <verify>
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.models.circle import Circle; from app.models.circle_membership import CircleMembership; print('Models OK')"`
    Verify migration file exists in alembic/versions/.
  </verify>
  <done>
    Circle and CircleMembership models exist with proper relationships and constraints. Schemas define request/response shapes. Migration creates tables with indexes and unique constraint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Circle service, invite service, API routes, and router registration</name>
  <files>
    backend/app/services/circle_service.py
    backend/app/services/invite_service.py
    backend/app/api/routes/circles.py
    backend/app/api/routes/invites.py
    backend/app/main.py
  </files>
  <action>
    **Services:**

    Create `backend/app/services/circle_service.py`:
    - `create_circle(name, user_id, db)`: Create circle + add creator as owner member. Validate user isn't in >20 circles already.
    - `get_user_circles(user_id, db)`: List circles where user is active member (left_at IS NULL). Include member count.
    - `get_circle_detail(circle_id, user_id, db)`: Get circle with membership check. Return circle info + members list.
    - `get_circle_members(circle_id, user_id, db)`: List active members. Verify requester is active member first.
    - `leave_circle(circle_id, user_id, db)`: Soft delete -- set left_at=now(). If owner leaving: if other members exist, transfer ownership to oldest member; if no other members, hard delete the circle.
    - `remove_member(circle_id, owner_id, target_user_id, db)`: Owner-only. Verify owner role. Set target's left_at=now(). Cannot remove self (use leave_circle).
    - `verify_active_membership(circle_id, user_id, db)`: Helper that returns CircleMembership or raises 403. Used by other services.

    Create `backend/app/services/invite_service.py`:
    - Use `itsdangerous.URLSafeTimedSerializer` with `settings.SECRET_KEY` and salt "circle-invite".
    - `generate_invite_token(circle_id, inviter_id)`: Serialize payload {circle_id, inviter_id}. Return token string.
    - `validate_invite_token(token, max_age=604800)`: Deserialize with 7-day max age. Check Redis key `used_invite:{token}` for replay prevention. Returns payload dict or raises ValueError with message.
    - `mark_token_used(token, redis)`: Set Redis key `used_invite:{token}` with 30-day TTL.
    - `accept_invite(token, user_id, db, redis)`: Validate token, check circle exists, check not already member (if soft-deleted, check if removed by owner vs self-leave -- only block rejoining if removed by owner), check circle has <10 members, create CircleMembership, mark token used. Return circle info.

    **API Routes:**

    Create `backend/app/api/routes/circles.py`:
    - `POST /api/v1/circles` -- Create circle. Returns CircleResponse.
    - `GET /api/v1/circles` -- List user's circles. Returns List[CircleResponse].
    - `GET /api/v1/circles/{circle_id}` -- Circle detail with members. Requires membership.
    - `GET /api/v1/circles/{circle_id}/members` -- List active members.
    - `POST /api/v1/circles/{circle_id}/leave` -- Leave circle (soft delete).
    - `DELETE /api/v1/circles/{circle_id}/members/{user_id}` -- Remove member (owner only).

    Create `backend/app/api/routes/invites.py`:
    - `POST /api/v1/circles/{circle_id}/invite` -- Generate invite. Requires active membership. Rate limit: 5 per circle per hour (check Redis counter).
    - `POST /api/v1/invites/{token}/accept` -- Accept invite and join circle.
    - `GET /api/v1/invites/{token}/info` -- Get circle name and inviter info from token without joining (for preview on mobile).

    Register both routers in `backend/app/main.py` under `/api/v1`.
  </action>
  <verify>
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.api.routes.circles import router; from app.api.routes.invites import router; print('Routes OK')"`
    Run: `cd /home/jbellot/Documents/repo/iris-art/backend && python -c "from app.services.circle_service import create_circle, leave_circle; from app.services.invite_service import generate_invite_token, validate_invite_token; print('Services OK')"`
  </verify>
  <done>
    6 circle API endpoints and 3 invite API endpoints return correct JSON responses. Invite tokens expire after 7 days, single-use enforced via Redis. Rate limiting on invite generation (5/hour/circle). Leave circle soft-deletes membership. Owner can remove members, ownership transfers on owner departure. Circle has 10-member limit.
  </done>
</task>

</tasks>

<verification>
- Backend: All model imports succeed, API routes registered in main.py, Alembic migration creates tables
- Circle CRUD: create, list, detail, members, leave, remove all return correct responses
- Invite flow: token generation, preview info, acceptance all work with proper validation
</verification>

<success_criteria>
- Circle model and CircleMembership model exist with UUID PKs, proper FK relationships, and soft delete (left_at)
- 6 circle API endpoints return correct JSON responses
- 3 invite API endpoints handle token generation, preview, and acceptance
- Invite tokens expire after 7 days, single-use enforced via Redis
- 10-member limit enforced on circle join
- Owner can remove members, ownership transfers on owner departure
</success_criteria>

<output>
After completion, create `.planning/phases/05-social-features-circles-and-fusion/05-01-SUMMARY.md`
</output>

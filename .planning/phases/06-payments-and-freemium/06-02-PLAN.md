---
phase: 06-payments-and-freemium
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/app/api/routes/styles.py
  - backend/app/api/routes/exports.py
  - mobile/src/screens/Exports/HDExportScreen.tsx
  - mobile/src/screens/Styles/StyleGalleryScreen.tsx
  - mobile/src/screens/Styles/AIGenerateScreen.tsx
  - mobile/src/hooks/useHDExport.ts
  - mobile/src/hooks/useRateLimit.ts
autonomous: true

must_haves:
  truths:
    - "User can purchase an HD export at 4.99 EUR through in-app purchase and receive watermark-free result"
    - "Premium styles are locked behind purchase and unlock after payment"
    - "Free users are rate-limited to 3 AI-processed images per month with clear messaging"
    - "Rate limit banner shows remaining quota or limit-reached state with upgrade prompt"
    - "HD export screen offers both free (watermarked) and paid (watermark-free) options with real payment flow"
  artifacts:
    - path: "mobile/src/screens/Exports/HDExportScreen.tsx"
      provides: "HD export with real payment flow"
      contains: "purchaseHDExport"
    - path: "mobile/src/screens/Styles/StyleGalleryScreen.tsx"
      provides: "Premium styles locked with purchase gate"
      contains: "PremiumGate"
    - path: "mobile/src/hooks/useRateLimit.ts"
      provides: "Rate limit status hook"
      exports: ["useRateLimit"]
    - path: "backend/app/api/routes/styles.py"
      provides: "Rate-limited AI generation endpoint"
      contains: "check_ai_generation_limit"
  key_links:
    - from: "mobile/src/screens/Exports/HDExportScreen.tsx"
      to: "mobile/src/services/purchases.ts"
      via: "HD export purchase triggers RevenueCat flow"
      pattern: "purchaseHDExport"
    - from: "mobile/src/screens/Styles/StyleGalleryScreen.tsx"
      to: "mobile/src/components/PremiumGate.tsx"
      via: "Premium styles wrapped in PremiumGate"
      pattern: "PremiumGate"
    - from: "backend/app/api/routes/styles.py"
      to: "backend/app/api/dependencies/rate_limit.py"
      via: "AI generation endpoint uses rate limit dependency"
      pattern: "Depends.*check_ai_generation_limit"
    - from: "mobile/src/screens/Styles/AIGenerateScreen.tsx"
      to: "mobile/src/hooks/useRateLimit.ts"
      via: "AI generation screen shows rate limit status"
      pattern: "useRateLimit"
---

<objective>
Wire payment flows into existing features -- premium style gates, HD export purchase, rate limiting on AI generation

Purpose: Connect the payment infrastructure from Plan 06-01 to existing Phase 4 features. Replace placeholder "Coming Soon" payment gates with real RevenueCat purchase flows. Add rate limiting to the AI generation endpoint. Update mobile screens to show premium gates, rate limit banners, and functional purchase buttons.

Output: Fully functional payment-gated features -- HD export with real IAP, locked premium styles with unlock, rate-limited AI generation with clear messaging
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-payments-and-freemium/06-RESEARCH.md
@.planning/phases/06-payments-and-freemium/06-01-SUMMARY.md
@.planning/phases/04-camera-guidance-and-artistic-styles/04-03-SUMMARY.md
@.planning/phases/04-camera-guidance-and-artistic-styles/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend feature gating -- rate limit on AI generation, premium style check, export payment verification</name>
  <files>
    backend/app/api/routes/styles.py
    backend/app/api/routes/exports.py
  </files>
  <action>
    **1. Rate limit AI generation endpoint** (`backend/app/api/routes/styles.py`):
    - Import `check_ai_generation_limit` from `app.api.dependencies.rate_limit`.
    - Add `Depends(check_ai_generation_limit)` to both the `/generate` endpoint (AI art generation) AND the `/apply` endpoint (preset style transfer). Both consume AI processing resources and should be rate-limited for free users.
    - The dependency returns the user if allowed, so replace the existing `get_current_active_user` dependency in these two endpoints with `check_ai_generation_limit` (which internally calls get_current_active_user and adds rate limit check). Keep `get_current_active_user` on the read-only endpoints (GET /presets, GET /jobs, GET /jobs/{id}).
    - After successful job creation in both `/apply` and `/generate`, call `RateLimitService.increment_usage(db, user)` to increment the counter. Import RateLimitService from app.services.rate_limiting. Increment AFTER successful Celery task dispatch (not before, so failed submissions don't waste quota).

    **2. Premium style check** (`backend/app/api/routes/styles.py`):
    - In the `/apply` endpoint, after loading the StylePreset, check `preset.tier`. If tier is "premium" and `user.is_premium` is False, raise HTTPException 403 with detail: {"error": "premium_required", "message": "This style requires Premium. Unlock all premium styles with a one-time purchase.", "product_id": "premium_styles"}.
    - This replaces the mobile "Coming Soon" alert with a real server-side gate.

    **3. Export payment verification** (`backend/app/api/routes/exports.py`):
    - Read the existing exports.py routes. Find the endpoint that creates HD export jobs.
    - Add an optional `is_paid` query parameter (bool, default False) to the export request. When is_paid=True, the endpoint should set ExportJob.is_paid=True only if verified server-side: call `check_entitlement(str(user.id), "pro")` from purchases service OR check if user has a recent Purchase record for the hd_export product matching this export_job_id.
    - For the MVP: trust the payment flow (webhook sets is_paid). The export endpoint itself does NOT need to verify -- the webhook handler in 06-01 already marks ExportJob.is_paid=True. However, add a GET endpoint `/api/v1/exports/{job_id}/payment-status` that returns whether the export job is marked as paid, so mobile can poll after purchase.
    - Ensure the HD export Celery task (already exists in `backend/app/workers/tasks/hd_export.py`) reads ExportJob.is_paid correctly -- if True, skip watermark. This should already work from Phase 4 (watermark service checks is_paid flag). Verify this and log it in the summary.
  </action>
  <verify>
    - `python -c "from app.api.routes.styles import router; print('Styles router OK')"` succeeds
    - `python -c "from app.api.routes.exports import router; print('Exports router OK')"` succeeds
    - Styles /apply endpoint has premium tier check (grep for "premium_required" in styles.py)
    - Styles /generate endpoint has rate limit dependency (grep for "check_ai_generation_limit" in styles.py)
    - Rate limit increment happens after successful job dispatch
  </verify>
  <done>
    AI generation and style apply endpoints enforce rate limits for free users (429 response with reset date and upgrade messaging when 3/month exceeded). Premium styles return 403 with clear upgrade messaging for free users. Export payment status endpoint exists for mobile polling. Watermark service correctly uses is_paid flag from ExportJob (verified from Phase 4 implementation).
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile payment UI -- HD export purchase flow, premium style gates, rate limit hook and messaging</name>
  <files>
    mobile/src/screens/Exports/HDExportScreen.tsx
    mobile/src/screens/Styles/StyleGalleryScreen.tsx
    mobile/src/screens/Styles/AIGenerateScreen.tsx
    mobile/src/hooks/useRateLimit.ts
    mobile/src/hooks/useHDExport.ts
  </files>
  <action>
    **1. useRateLimit hook** (`mobile/src/hooks/useRateLimit.ts`):
    - Fetch rate limit status from backend: GET /api/v1/purchases/rate-limit-status
    - State: currentUsage, limit, resetDate, isPremium, isLoading
    - `refresh()`: Re-fetch status from backend.
    - Auto-fetch on mount.
    - Return: { currentUsage, limit, resetDate, isPremium, isLoading, remaining (computed: limit - currentUsage), isLimitReached (computed: currentUsage >= limit), refresh }

    **2. Update HDExportScreen** (`mobile/src/screens/Exports/HDExportScreen.tsx`):
    - Import `usePurchases` hook and `purchaseHDExport` from purchases service.
    - Replace the `handlePaymentGate` function (currently shows "Coming Soon" alert) with a real purchase flow:
      - Call `purchaseHDExport(exportJobId)` which triggers RevenueCat purchase.
      - On success: show success message, then request HD export with is_paid context. The webhook will mark ExportJob.is_paid=True asynchronously. Poll `/api/v1/exports/{job_id}/payment-status` every 2 seconds (max 30s) until is_paid=true, then proceed with export.
      - On user cancel: do nothing (user can try again).
      - On error: show error alert with retry option.
    - Update the paid export card: remove `styles.paymentCardDisabled` and `styles.exportButtonDisabled`. Change button text from "Export HD without watermark" to "Export HD (4.99 EUR, no watermark)". Make button fully functional.
    - Keep the free export option working as-is (with watermark).
    - Add loading state during purchase flow (ActivityIndicator on the paid button while purchasing).

    **3. Update StyleGalleryScreen** (`mobile/src/screens/Styles/StyleGalleryScreen.tsx`):
    - Import `PremiumGate` component from `../../components/PremiumGate`.
    - Import `usePurchases` hook.
    - For premium style presets: wrap each premium StyleThumbnail (or the premium section) in `<PremiumGate feature="Premium Styles" onUpgrade={handleUpgrade}>`. The onUpgrade handler calls `purchasePremiumStyles()` from the purchases service.
    - Replace the existing "Coming Soon" alert on premium style tap with the PremiumGate behavior: if not premium, tapping shows the gate overlay. If premium, tapping navigates to StylePreviewScreen as normal.
    - Add a "Restore Purchases" button in the screen header or bottom (text link style) that calls `restorePurchases()` from usePurchases hook.

    **4. Update AIGenerateScreen** (`mobile/src/screens/Styles/AIGenerateScreen.tsx`):
    - Import `useRateLimit` hook and `RateLimitBanner` component.
    - Add RateLimitBanner at the top of the screen showing remaining AI generations or limit-reached state.
    - If rate limit reached (isLimitReached=true): disable the generate button, show the RateLimitBanner in warning mode with upgrade prompt.
    - Handle 429 error response from the generate API: parse the error detail (message, current_usage, limit, reset_date) and show Alert with "Monthly Limit Reached" title, detail message, "Maybe Later" and "Upgrade" buttons. The "Upgrade" button calls purchasePremiumStyles (premium users get unlimited generations).
    - After successful generation, call `rateLimit.refresh()` to update the banner count.

    **5. Update useHDExport hook** (`mobile/src/hooks/useHDExport.ts`):
    - Add a `pollPaymentStatus(exportJobId)` method: polls GET /api/v1/exports/{job_id}/payment-status every 2 seconds for up to 30 seconds. Returns true when is_paid=true, false on timeout.
    - Export this method so HDExportScreen can use it after purchase completion.
  </action>
  <verify>
    - HDExportScreen.tsx contains `purchaseHDExport` call (not "Coming Soon" alert)
    - StyleGalleryScreen.tsx contains `PremiumGate` import and usage
    - AIGenerateScreen.tsx contains `RateLimitBanner` and `useRateLimit`
    - useRateLimit.ts hook exports { currentUsage, limit, resetDate, isPremium, remaining, isLimitReached }
    - useHDExport.ts exports pollPaymentStatus method
    - All files compile without TypeScript errors (check imports resolve)
  </verify>
  <done>
    HDExportScreen has real purchase flow: free export (with watermark) and paid export (4.99 EUR, no watermark) both functional. Paid export triggers RevenueCat purchase, polls payment status, then starts watermark-free export. StyleGalleryScreen wraps premium styles in PremiumGate with real purchase flow (not "Coming Soon"). AIGenerateScreen shows rate limit banner with remaining count, disables generate button when limit reached, handles 429 errors with upgrade prompt. All payment gates degrade gracefully in dev mode (RevenueCat not configured = free features work, paid features show error with explanation).
  </done>
</task>

</tasks>

<verification>
- Backend: `/api/v1/styles/generate` returns 429 when free user exceeds 3 generations/month
- Backend: `/api/v1/styles/apply` returns 403 when free user tries premium style
- Backend: `/api/v1/exports/{id}/payment-status` returns is_paid status
- Mobile: HDExportScreen paid button triggers RevenueCat purchase (or graceful error in dev)
- Mobile: Premium styles wrapped in PremiumGate on StyleGalleryScreen
- Mobile: RateLimitBanner visible on AIGenerateScreen showing remaining quota
- Mobile: 429 error from generate API shows user-friendly limit-reached alert with upgrade option
</verification>

<success_criteria>
- All 5 Phase 6 success criteria met:
  1. User can purchase HD export at 4.99 EUR through IAP (HDExportScreen wired to RevenueCat)
  2. Premium styles locked behind purchase (PremiumGate on StyleGalleryScreen, 403 on backend)
  3. Free users rate-limited to 3 AI images/month with messaging (RateLimitBanner + 429 handler)
  4. Receipts validated server-side (webhook handler verifies via RevenueCat REST API)
- No "Coming Soon" placeholders remain in payment-related UI
- Free features (watermarked export, free styles, up-to-limit AI generation) still work without RevenueCat configured
</success_criteria>

<output>
After completion, create `.planning/phases/06-payments-and-freemium/06-02-SUMMARY.md`
</output>

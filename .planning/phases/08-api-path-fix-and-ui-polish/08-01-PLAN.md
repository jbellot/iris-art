---
phase: 08-api-path-fix-and-ui-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/api/routes/circles.py
  - backend/app/api/routes/invites.py
  - backend/app/api/routes/consent.py
  - mobile/src/services/circles.ts
  - mobile/src/services/invites.ts
  - mobile/src/services/fusion.ts
  - mobile/src/services/artworkConsent.ts
  - mobile/src/services/exports.ts
  - mobile/src/services/styles.ts
  - mobile/src/screens/Processing/ProcessingResultScreen.tsx
  - mobile/src/screens/Styles/StylePreviewScreen.tsx
  - mobile/src/screens/Circles/FusionResultScreen.tsx
  - mobile/ios/IrisArt/Info.plist
  - mobile/android/app/src/main/AndroidManifest.xml
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All 6 mobile service files make API calls that resolve to correct backend endpoints without double /api/v1 prefix"
    - "Circles, invites, and consent backend routes are accessible under /api/v1 prefix (consistent with all other routes)"
    - "User can save processed iris art to device camera roll from ProcessingResultScreen"
    - "User can save styled art to device camera roll from StylePreviewScreen"
    - "User can save fusion/composition art to device camera roll from FusionResultScreen"
  artifacts:
    - path: "mobile/src/services/circles.ts"
      provides: "Circle API calls without /api/v1 prefix"
      contains: "apiClient.get.*'/circles'"
    - path: "mobile/src/services/invites.ts"
      provides: "Invite API calls without /api/v1 prefix"
      contains: "apiClient.post.*'/circles/"
    - path: "mobile/src/services/fusion.ts"
      provides: "Fusion API calls without /api/v1 prefix"
      contains: "apiClient.post.*'/fusion'"
    - path: "mobile/src/services/artworkConsent.ts"
      provides: "Consent API calls without /api/v1 prefix"
      contains: "apiClient.post.*'/consent/"
    - path: "mobile/src/services/exports.ts"
      provides: "Export API calls without /api/v1 prefix"
      contains: "apiClient.post.*'/exports/hd'"
    - path: "mobile/src/services/styles.ts"
      provides: "Style API calls without /api/v1 prefix"
      contains: "api.get.*'/styles/presets'"
    - path: "backend/app/api/routes/circles.py"
      provides: "Circles router with /api/v1/circles prefix"
      contains: 'prefix="/api/v1/circles"'
    - path: "backend/app/api/routes/invites.py"
      provides: "Invites router with /api/v1/circles prefix"
      contains: 'prefix="/api/v1/circles"'
    - path: "backend/app/api/routes/consent.py"
      provides: "Consent router with /api/v1/consent prefix"
      contains: 'prefix="/api/v1/consent"'
    - path: "mobile/src/screens/Processing/ProcessingResultScreen.tsx"
      provides: "Working save to device with CameraRoll"
      contains: "CameraRoll.save"
    - path: "mobile/src/screens/Styles/StylePreviewScreen.tsx"
      provides: "Working save to device with CameraRoll"
      contains: "CameraRoll.save"
    - path: "mobile/src/screens/Circles/FusionResultScreen.tsx"
      provides: "Working save to device with CameraRoll"
      contains: "CameraRoll.save"
  key_links:
    - from: "mobile/src/services/circles.ts"
      to: "backend/app/api/routes/circles.py"
      via: "axios GET /circles -> backend prefix /api/v1/circles"
      pattern: "apiClient\\.get.*'/circles'"
    - from: "mobile/src/services/fusion.ts"
      to: "backend/app/api/routes/fusion.py"
      via: "axios POST /fusion -> backend prefix /api/v1/fusion"
      pattern: "apiClient\\.post.*'/fusion'"
    - from: "mobile/src/screens/Processing/ProcessingResultScreen.tsx"
      to: "@react-native-camera-roll/camera-roll"
      via: "RNFS download then CameraRoll.save"
      pattern: "CameraRoll\\.save"
---

<objective>
Fix API path double-prefix bug across 6 mobile service files and implement Save to Device functionality in 3 result screens.

Purpose: All mobile API calls currently fail with 404 errors because endpoint paths include `/api/v1` prefix that duplicates the axios baseURL. Additionally, "Save to Device" buttons on result screens are placeholders. This plan closes both gaps from the v1.0 milestone audit.

Output: Working API integration for circles, invites, fusion, consent, exports, and styles; working save-to-camera-roll on ProcessingResultScreen, StylePreviewScreen, and FusionResultScreen.
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-api-path-fix-and-ui-polish/08-RESEARCH.md
@mobile/src/utils/constants.ts (API_BASE_URL includes /api/v1)
@mobile/src/services/api.ts (axios baseURL = API_BASE_URL)
@backend/app/main.py (router registration — lines 77-91)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix API path routing — backend prefix consistency and mobile path cleanup</name>
  <files>
    backend/app/api/routes/circles.py
    backend/app/api/routes/invites.py
    backend/app/api/routes/consent.py
    mobile/src/services/circles.ts
    mobile/src/services/invites.ts
    mobile/src/services/fusion.ts
    mobile/src/services/artworkConsent.ts
    mobile/src/services/exports.ts
    mobile/src/services/styles.ts
  </files>
  <action>
    **Root cause:** The axios baseURL is `http://localhost:8000/api/v1` (set in `mobile/src/utils/constants.ts`). Mobile service files include `/api/v1` in their endpoint paths, doubling the prefix. Additionally, 3 backend routers (circles, invites, consent) lack the `/api/v1` prefix that all other routers use, creating a routing inconsistency.

    **Part A — Backend route prefix consistency:**

    Fix 3 backend routers that are missing the `/api/v1` prefix. All other routers (auth, users, photos, processing, styles, exports) already use `/api/v1` in their APIRouter prefix.

    1. `backend/app/api/routes/circles.py`: Change `APIRouter(prefix="/circles", tags=["circles"])` to `APIRouter(prefix="/api/v1/circles", tags=["circles"])`. The router defines these endpoints: `""` (POST create, GET list), `"/{circle_id}"` (GET detail), `"/{circle_id}/members"` (GET), `"/{circle_id}/leave"` (POST), `"/{circle_id}/gallery"` (GET). All will now be under `/api/v1/circles/...`.

    2. `backend/app/api/routes/invites.py`: Change `APIRouter(prefix="/circles", tags=["invites"])` to `APIRouter(prefix="/api/v1/circles", tags=["invites"])`. The router defines: `"/invites/{token}/info"` (GET) and `"/invites/accept"` (POST). These become `/api/v1/circles/invites/{token}/info` and `/api/v1/circles/invites/accept`.

    3. `backend/app/api/routes/consent.py`: Change `APIRouter(prefix="/consent", tags=["consent"])` to `APIRouter(prefix="/api/v1/consent", tags=["consent"])`. The router defines: `"/request"` (POST), `"/pending"` (GET), `"/{consent_id}/decide"` (POST), `"/{consent_id}/revoke"` (POST), `"/status"` (GET). All become `/api/v1/consent/...`.

    **Part B — Mobile service path cleanup:**

    Remove the `/api/v1` prefix from all endpoint paths in 6 mobile service files. The axios baseURL already provides this prefix, so service files must use relative paths.

    4. `mobile/src/services/circles.ts`: Replace all 6 occurrences of `/api/v1/circles` with `/circles`. Specifically:
       - `'/api/v1/circles'` → `'/circles'` (getCircles, createCircle)
       - `` `/api/v1/circles/${circleId}` `` → `` `/circles/${circleId}` `` (getCircleDetail)
       - `` `/api/v1/circles/${circleId}/members` `` → `` `/circles/${circleId}/members` `` (getCircleMembers)
       - `` `/api/v1/circles/${circleId}/leave` `` → `` `/circles/${circleId}/leave` `` (leaveCircle)
       - `` `/api/v1/circles/${circleId}/members/${userId}` `` → `` `/circles/${circleId}/members/${userId}` `` (removeMember)

    5. `mobile/src/services/invites.ts`: Replace all 3 occurrences:
       - `` `/api/v1/circles/${circleId}/invite` `` → `` `/circles/${circleId}/invite` `` (createInvite)
       - `` `/api/v1/invites/${token}/info` `` → `` `/invites/${token}/info` `` (getInviteInfo — NOTE: this maps to the invites router which is under `/api/v1/circles/invites/{token}/info`, but since baseURL provides `/api/v1`, and the invites router sits under the circles prefix, check the actual route. The invites router has `prefix="/api/v1/circles"` after Part A fix, and route `"/invites/{token}/info"`, so full path = `/api/v1/circles/invites/{token}/info`. Mobile path should be `/circles/invites/${token}/info`.)
       - `` `/api/v1/invites/${token}/accept` `` → `` `/circles/invites/accept` `` (acceptInvite — the backend route is `POST /api/v1/circles/invites/accept` with token in request body. Check the backend: `invites.py` has `@router.post("/invites/accept", ...)`. So mobile path should be `/circles/invites/accept` and pass the token as query param or body per the backend signature.)

       **IMPORTANT**: Read `backend/app/api/routes/invites.py` carefully for the acceptInvite endpoint signature. The current mobile code passes `token` in the URL path but the backend may expect it differently. The backend route is `POST /circles/invites/accept` (after prefix fix: `/api/v1/circles/invites/accept`). Verify how the token is passed (path param, query param, or body) and update the mobile call accordingly. If the backend expects a body parameter `{token: "..."}`, update the mobile service to post with body.

    6. `mobile/src/services/fusion.ts`: Replace all 4 occurrences:
       - `'/api/v1/fusion'` → `'/fusion'` (createFusion, getUserFusions)
       - `'/api/v1/composition'` → `'/composition'` (createComposition)
       - `` `/api/v1/fusion/${fusionId}` `` → `` `/fusion/${fusionId}` `` (getFusionStatus)

    7. `mobile/src/services/artworkConsent.ts`: Replace all 5 occurrences:
       - `'/api/v1/consent/request'` → `'/consent/request'` (requestConsent)
       - `'/api/v1/consent/pending'` → `'/consent/pending'` (getPendingConsents)
       - `` `/api/v1/consent/${consentId}/decide` `` → `` `/consent/${consentId}/decide` `` (decideConsent)
       - `` `/api/v1/consent/${consentId}/revoke` `` → `` `/consent/${consentId}/revoke` `` (revokeConsent)
       - `'/api/v1/consent/status'` → `'/consent/status'` (getConsentStatus)

    8. `mobile/src/services/exports.ts`: Replace all 4 occurrences:
       - `'/api/v1/exports/hd'` → `'/exports/hd'` (requestHDExport)
       - `` `/api/v1/exports/jobs/${jobId}` `` → `` `/exports/jobs/${jobId}` `` (getExportJob)
       - `'/api/v1/exports/jobs'` → `'/exports/jobs'` (getExportJobs)
       - `'/api/v1/styles/generate'` → `'/styles/generate'` (generateAIArt — this function is in exports.ts but calls a styles endpoint)

    9. `mobile/src/services/styles.ts`: Replace all 4 occurrences:
       - `'/api/v1/styles/presets'` → `'/styles/presets'` (getStylePresets)
       - `'/api/v1/styles/apply'` → `'/styles/apply'` (applyStyle)
       - `` `/api/v1/styles/jobs/${jobId}` `` → `` `/styles/jobs/${jobId}` `` (getStyleJob)
       - `'/api/v1/styles/jobs'` → `'/styles/jobs'` (getStyleJobs)

    **Validation approach:** After all changes, verify no remaining `/api/v1` appears in any mobile service file endpoint paths by running: `grep -r '/api/v1' mobile/src/services/`. The only occurrence should be in `api.ts` (baseURL constant reference) and `consent.ts` (the privacy/biometric consent service, separate from artworkConsent.ts).
  </action>
  <verify>
    1. Run `grep -rn '/api/v1/' mobile/src/services/circles.ts mobile/src/services/invites.ts mobile/src/services/fusion.ts mobile/src/services/artworkConsent.ts mobile/src/services/exports.ts mobile/src/services/styles.ts` — should return zero matches
    2. Run `grep -n 'prefix=' backend/app/api/routes/circles.py backend/app/api/routes/invites.py backend/app/api/routes/consent.py` — all should show `/api/v1/` prefix
    3. Run `cd /home/jbellot/Documents/repo/iris-art/mobile && npx tsc --noEmit 2>&1 | head -30` — no new TypeScript errors introduced
  </verify>
  <done>
    All 6 mobile service files use paths relative to the axios baseURL (no `/api/v1` prefix in endpoint strings). Backend circles, invites, and consent routers include `/api/v1` prefix consistent with all other routers. API calls resolve to correct backend URLs: e.g., mobile `GET /circles` → axios → `http://localhost:8000/api/v1/circles` → backend circles router.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Save to Device with CameraRoll in 3 result screens</name>
  <files>
    mobile/src/screens/Processing/ProcessingResultScreen.tsx
    mobile/src/screens/Styles/StylePreviewScreen.tsx
    mobile/src/screens/Circles/FusionResultScreen.tsx
    mobile/ios/IrisArt/Info.plist
    mobile/android/app/src/main/AndroidManifest.xml
  </files>
  <action>
    **Install @react-native-camera-roll/camera-roll:**

    ```bash
    cd /home/jbellot/Documents/repo/iris-art/mobile
    npm install @react-native-camera-roll/camera-roll --legacy-peer-deps
    ```

    Use `--legacy-peer-deps` because project uses React 19 which may have peer dep conflicts (same pattern as Phase 06-01 for react-native-purchases). If the install fails with peer dep errors, use `--legacy-peer-deps`. Then run `cd ios && pod install && cd ..` for iOS native linking.

    **Add platform permissions:**

    1. `mobile/ios/IrisArt/Info.plist`: Add these two keys inside the `<dict>` element, before the closing `</dict>`:
       ```xml
       <key>NSPhotoLibraryAddUsageDescription</key>
       <string>Save your iris artwork to your photo library</string>
       <key>NSPhotoLibraryUsageDescription</key>
       <string>Access your photos to share iris artwork</string>
       ```
       `NSPhotoLibraryAddUsageDescription` is the write-only permission (iOS 14+), which is the minimum needed. `NSPhotoLibraryUsageDescription` is the full read/write permission, included for CameraRoll compatibility.

    2. `mobile/android/app/src/main/AndroidManifest.xml`: Add these permissions BEFORE the `<application>` tag:
       ```xml
       <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
       <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="32" />
       ```
       `READ_MEDIA_IMAGES` is for Android 13+ (API 33). `WRITE_EXTERNAL_STORAGE` with `maxSdkVersion="32"` covers Android 12 and below. The `@react-native-camera-roll/camera-roll` package handles the permission request flow internally.

    **Create a shared utility function** `mobile/src/utils/saveToDevice.ts`:

    Create a reusable function that handles the download-then-save pattern to avoid code duplication across 3 screens:

    ```typescript
    import RNFS from 'react-native-fs';
    import { CameraRoll } from '@react-native-camera-roll/camera-roll';
    import { Platform, Alert } from 'react-native';
    import { check, request, PERMISSIONS, RESULTS } from 'react-native-permissions';

    const requestPhotoPermission = async (): Promise<boolean> => {
      const permission = Platform.select({
        ios: PERMISSIONS.IOS.PHOTO_LIBRARY_ADD_ONLY,
        android: Number(Platform.Version) >= 33
          ? PERMISSIONS.ANDROID.READ_MEDIA_IMAGES
          : PERMISSIONS.ANDROID.WRITE_EXTERNAL_STORAGE,
      });

      if (!permission) return false;

      const result = await check(permission);
      if (result === RESULTS.GRANTED || result === RESULTS.LIMITED) return true;

      if (result === RESULTS.DENIED) {
        const requestResult = await request(permission);
        return requestResult === RESULTS.GRANTED || requestResult === RESULTS.LIMITED;
      }

      Alert.alert(
        'Permission Required',
        'Please enable photo library access in Settings to save images.',
        [{ text: 'OK' }],
      );
      return false;
    };

    export const saveImageToDevice = async (imageUrl: string): Promise<boolean> => {
      const hasPermission = await requestPhotoPermission();
      if (!hasPermission) return false;

      const tempPath = `${RNFS.TemporaryDirectoryPath}/iris_${Date.now()}.jpg`;

      try {
        const download = await RNFS.downloadFile({
          fromUrl: imageUrl,
          toFile: tempPath,
        }).promise;

        if (download.statusCode !== 200) {
          throw new Error(`Download failed with status ${download.statusCode}`);
        }

        await CameraRoll.save(`file://${tempPath}`, { type: 'photo' });

        // Clean up temp file
        try {
          await RNFS.unlink(tempPath);
        } catch {
          // Ignore cleanup errors
        }

        Alert.alert('Saved', 'Image saved to your photo library!');
        return true;
      } catch (error) {
        // Clean up on failure too
        try {
          await RNFS.unlink(tempPath);
        } catch {
          // Ignore
        }

        console.error('Failed to save image:', error);
        Alert.alert('Error', 'Failed to save image to device. Please try again.');
        return false;
      }
    };
    ```

    **Update ProcessingResultScreen.tsx:**

    Replace the placeholder `handleSaveToDevice` function. Remove the TODO comment and placeholder Alert. Import `saveImageToDevice` from `../../utils/saveToDevice`. Add a `saving` state variable (`const [saving, setSaving] = useState(false)`). Implement:

    ```typescript
    const handleSaveToDevice = async () => {
      if (!job || !job.result_url || saving) return;
      setSaving(true);
      try {
        await saveImageToDevice(job.result_url);
      } finally {
        setSaving(false);
      }
    };
    ```

    Add `useState` to existing imports if not already there (it is). Add `ActivityIndicator` or disable the save button while `saving` is true (add `disabled={saving}` and show "Saving..." text when saving).

    **Update StylePreviewScreen.tsx:**

    Remove the placeholder `CameraRoll` object at the top of the file (lines 21-26 that define a mock CameraRoll). Import `saveImageToDevice` from `../../utils/saveToDevice`. Add a `saving` state. Replace the `handleSave` function:

    ```typescript
    const handleSave = async () => {
      if (!activeJob?.resultUrl || saving) return;
      setSaving(true);
      try {
        await saveImageToDevice(activeJob.resultUrl);
      } finally {
        setSaving(false);
      }
    };
    ```

    Remove the `CameraRoll` import/mock since it's no longer needed directly. Keep the Alert import for the "Not Ready" check but move it before the saveImageToDevice call.

    **Update FusionResultScreen.tsx:**

    Import `saveImageToDevice` from `../../utils/saveToDevice`. Replace the placeholder `handleSaveToGallery` function:

    ```typescript
    const handleSaveToGallery = async () => {
      if (!resultUrl || saving) return;
      setSaving(true);
      try {
        await saveImageToDevice(resultUrl);
      } finally {
        setSaving(false);
      }
    };
    ```

    The `saving` state already exists in FusionResultScreen (line 31). Update the save button to show disabled state while saving (add `disabled={saving}` and opacity).
  </action>
  <verify>
    1. Run `cd /home/jbellot/Documents/repo/iris-art/mobile && npx tsc --noEmit 2>&1 | head -30` — no TypeScript errors
    2. Run `grep -n 'CameraRoll.save\|saveImageToDevice' mobile/src/screens/Processing/ProcessingResultScreen.tsx mobile/src/screens/Styles/StylePreviewScreen.tsx mobile/src/screens/Circles/FusionResultScreen.tsx` — all 3 screens should have saveImageToDevice calls
    3. Run `grep -n 'TODO.*save\|placeholder\|will be implemented' mobile/src/screens/Processing/ProcessingResultScreen.tsx mobile/src/screens/Styles/StylePreviewScreen.tsx mobile/src/screens/Circles/FusionResultScreen.tsx` — should return zero matches (no remaining TODOs)
    4. Run `grep -n 'NSPhotoLibrary' mobile/ios/IrisArt/Info.plist` — should show both permission keys
    5. Run `grep -n 'READ_MEDIA_IMAGES' mobile/android/app/src/main/AndroidManifest.xml` — should show the permission
    6. Run `ls mobile/node_modules/@react-native-camera-roll/camera-roll/package.json` — package installed
  </verify>
  <done>
    All 3 result screens (ProcessingResultScreen, StylePreviewScreen, FusionResultScreen) have working save-to-device functionality using @react-native-camera-roll/camera-roll with react-native-fs for downloading remote images. iOS Info.plist has NSPhotoLibraryAddUsageDescription and NSPhotoLibraryUsageDescription keys. Android manifest has READ_MEDIA_IMAGES and WRITE_EXTERNAL_STORAGE permissions. No placeholder TODOs remain.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn '/api/v1/' mobile/src/services/circles.ts mobile/src/services/invites.ts mobile/src/services/fusion.ts mobile/src/services/artworkConsent.ts mobile/src/services/exports.ts mobile/src/services/styles.ts` — zero matches confirms no double-prefix in mobile services
2. `grep -rn 'prefix=' backend/app/api/routes/circles.py backend/app/api/routes/invites.py backend/app/api/routes/consent.py` — all show `/api/v1/` prefix
3. `grep -rn 'saveImageToDevice\|CameraRoll.save' mobile/src/screens/` — all 3 result screens have save implementation
4. `grep -rn 'TODO.*save\|placeholder.*save\|will be implemented' mobile/src/screens/` — zero matches
5. `cd /home/jbellot/Documents/repo/iris-art/mobile && npx tsc --noEmit` — no new TypeScript errors
</verification>

<success_criteria>
- All 6 mobile service files use relative API paths (no `/api/v1` in endpoint strings)
- Backend circles, invites, and consent routers have `/api/v1` prefix matching all other routers
- Mobile API paths resolve correctly: e.g., mobile `'/circles'` + baseURL `/api/v1` = `http://localhost:8000/api/v1/circles` matches backend `circles.router prefix="/api/v1/circles"`
- ProcessingResultScreen saves processed image to device camera roll via download-then-save pattern
- StylePreviewScreen saves styled image to device camera roll (no more mock CameraRoll)
- FusionResultScreen saves fusion image to device camera roll (no more placeholder alert)
- iOS Info.plist has NSPhotoLibraryAddUsageDescription and NSPhotoLibraryUsageDescription
- Android manifest has READ_MEDIA_IMAGES and WRITE_EXTERNAL_STORAGE permissions
- No remaining TODO/placeholder comments for save functionality
</success_criteria>

<output>
After completion, create `.planning/phases/08-api-path-fix-and-ui-polish/08-01-SUMMARY.md`
</output>

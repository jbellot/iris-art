---
phase: 02-camera-capture-and-image-upload
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - mobile/src/screens/Gallery/GalleryScreen.tsx
  - mobile/src/screens/Gallery/PhotoDetailScreen.tsx
  - mobile/src/components/Gallery/PhotoThumbnail.tsx
  - mobile/src/components/Gallery/UploadProgressOverlay.tsx
  - mobile/src/components/Gallery/EmptyGallery.tsx
  - mobile/src/hooks/useGallery.ts
  - mobile/src/navigation/RootNavigator.tsx
  - mobile/src/navigation/types.ts
autonomous: false

must_haves:
  truths:
    - "User can view a masonry gallery of all their captured iris photos, ordered newest first"
    - "Gallery loads photos from backend API with efficient image caching (FastImage)"
    - "During upload, photo thumbnail shows progress bar overlay with percentage"
    - "Failed upload shows error indicator on thumbnail with tap-to-retry"
    - "Tapping a completed photo opens full-screen detail view with pinch-to-zoom"
    - "Empty gallery shows prompt to capture first iris photo"
    - "Gallery works smoothly on iPhone 12+ and Android 12MP+ devices"
  artifacts:
    - path: "mobile/src/screens/Gallery/GalleryScreen.tsx"
      provides: "Masonry gallery using FlashList with photo thumbnails, upload progress, and capture FAB"
      min_lines: 60
    - path: "mobile/src/screens/Gallery/PhotoDetailScreen.tsx"
      provides: "Full-screen photo view with pinch-to-zoom and swipe-to-dismiss"
      min_lines: 40
    - path: "mobile/src/components/Gallery/PhotoThumbnail.tsx"
      provides: "Individual photo tile with FastImage, upload progress overlay, and error state"
      min_lines: 30
    - path: "mobile/src/components/Gallery/UploadProgressOverlay.tsx"
      provides: "Semi-transparent overlay with progress bar on photo thumbnail during upload"
      min_lines: 20
    - path: "mobile/src/hooks/useGallery.ts"
      provides: "React Query hook for fetching paginated photos with infinite scroll"
      min_lines: 30
  key_links:
    - from: "mobile/src/hooks/useGallery.ts"
      to: "backend/app/api/routes/photos.py"
      via: "GET /api/v1/photos with pagination, returns presigned URLs"
      pattern: "api/v1/photos"
    - from: "mobile/src/components/Gallery/PhotoThumbnail.tsx"
      to: "mobile/src/hooks/useUpload.ts"
      via: "Reads upload state to show progress overlay or error indicator"
      pattern: "useUpload|uploadProgress"
    - from: "mobile/src/screens/Gallery/GalleryScreen.tsx"
      to: "mobile/src/screens/Camera/CameraScreen.tsx"
      via: "Capture FAB navigates to camera"
      pattern: "navigate.*Camera"
---

<objective>
Build the masonry photo gallery with upload progress visualization, photo detail view, and validate the complete flow on target devices. This completes the Phase 2 user journey: capture -> upload -> view in gallery.

Purpose: The gallery is where users spend most of their time in the app. It must load efficiently, show upload progress clearly, and display photos beautifully in a masonry layout. Device testing validates the entire Phase 2 flow works on real hardware.

Output:
- Masonry gallery with FlashList, FastImage caching, infinite scroll
- Upload progress overlay on thumbnails during active uploads
- Full-screen photo detail view with pinch-to-zoom
- Device testing validation on iOS and Android
</objective>

<execution_context>
@/home/jbellot/.claude/get-shit-done/workflows/execute-plan.md
@/home/jbellot/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-camera-capture-and-image-upload/02-CONTEXT.md
@.planning/phases/02-camera-capture-and-image-upload/02-RESEARCH.md

# Prior plans in this phase
@.planning/phases/02-camera-capture-and-image-upload/02-01-SUMMARY.md
@.planning/phases/02-camera-capture-and-image-upload/02-02-SUMMARY.md

# Key mobile files from Plans 01 and 02
@mobile/src/navigation/RootNavigator.tsx
@mobile/src/navigation/types.ts
@mobile/src/hooks/useUpload.ts
@mobile/src/services/api.ts
@mobile/src/types/photo.ts
@mobile/src/utils/constants.ts

# Backend photo API
@backend/app/api/routes/photos.py
@backend/app/schemas/photo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement masonry gallery with upload progress, photo detail view, and empty state</name>
  <files>
    mobile/src/screens/Gallery/GalleryScreen.tsx
    mobile/src/screens/Gallery/PhotoDetailScreen.tsx
    mobile/src/components/Gallery/PhotoThumbnail.tsx
    mobile/src/components/Gallery/UploadProgressOverlay.tsx
    mobile/src/components/Gallery/EmptyGallery.tsx
    mobile/src/hooks/useGallery.ts
    mobile/src/navigation/RootNavigator.tsx
    mobile/src/navigation/types.ts
  </files>
  <action>
    **Step 1: Create useGallery hook**
    Create `src/hooks/useGallery.ts` using React Query:

    ```typescript
    import { useInfiniteQuery } from '@tanstack/react-query';

    function useGallery() {
      const {
        data,
        isLoading,
        isError,
        fetchNextPage,
        hasNextPage,
        isFetchingNextPage,
        refetch,
      } = useInfiniteQuery({
        queryKey: ['photos'],
        queryFn: async ({ pageParam = 1 }) => {
          const response = await api.get('/photos', {
            params: { page: pageParam, page_size: 20 },
          });
          return response.data; // PhotoListResponse
        },
        getNextPageParam: (lastPage) => {
          const { page, page_size, total } = lastPage;
          if (page * page_size < total) return page + 1;
          return undefined;
        },
        initialPageParam: 1,
        staleTime: 60_000, // 1 minute
      });

      // Flatten pages into single photo array
      const photos = data?.pages.flatMap(page => page.items) ?? [];

      return { photos, isLoading, isError, fetchNextPage, hasNextPage, isFetchingNextPage, refetch };
    }
    ```

    **Step 2: Create UploadProgressOverlay component**
    Create `src/components/Gallery/UploadProgressOverlay.tsx`:
    - Semi-transparent dark overlay (rgba 0,0,0,0.5) on top of photo thumbnail
    - Shows horizontal progress bar at bottom of thumbnail
    - Progress bar fills from left to right based on percentage (0-100)
    - Progress percentage text centered on overlay
    - For failed status: show error icon (red X or exclamation) with "Tap to retry" text

    **Step 3: Create PhotoThumbnail component**
    Create `src/components/Gallery/PhotoThumbnail.tsx`:

    ```typescript
    interface PhotoThumbnailProps {
      photo: Photo;
      uploadState?: UploadItem; // from useUpload, if this photo is currently uploading
      onPress: (photo: Photo) => void;
      width: number; // calculated by masonry layout
    }
    ```

    - Uses FastImage for efficient image loading with caching:
      ```typescript
      <FastImage
        source={{
          uri: photo.thumbnail_url || photo.original_url,
          priority: FastImage.priority.normal,
          cache: FastImage.cacheControl.immutable,
        }}
        style={{ width, height: calculatedHeight }}
        resizeMode={FastImage.resizeMode.cover}
      />
      ```
    - Calculate height from photo aspect ratio (width/height) to create masonry effect
    - If `uploadState` provided and status is 'uploading': overlay UploadProgressOverlay with progress
    - If `uploadState` provided and status is 'failed': overlay UploadProgressOverlay with error state, onPress triggers retry instead of navigation
    - If no upload state or completed: onPress navigates to PhotoDetail
    - Rounded corners (8px border radius)
    - Small shadow for depth

    **Step 4: Create EmptyGallery component**
    Create `src/components/Gallery/EmptyGallery.tsx`:
    - Centered content: camera icon, "No photos yet" heading, "Capture your first iris photo" subtitle
    - "Start Capturing" button that navigates to Camera screen
    - Clean, minimal design matching app aesthetic

    **Step 5: Implement GalleryScreen (replace placeholder)**
    Replace the placeholder `src/screens/Gallery/GalleryScreen.tsx` with full implementation:

    - **Layout:** FlashList in masonry mode with 2 columns
      ```typescript
      <FlashList
        data={galleryItems} // merged: uploading photos + API photos
        renderItem={({ item }) => (
          <PhotoThumbnail
            photo={item}
            uploadState={getUploadState(item)}
            onPress={handlePhotoPress}
            width={columnWidth}
          />
        )}
        estimatedItemSize={200}
        numColumns={2}
        // FlashList masonry is via variable item heights
        // Each item calculates its own height from aspect ratio
        onEndReached={() => hasNextPage && fetchNextPage()}
        onEndReachedThreshold={0.5}
        refreshing={isLoading}
        onRefresh={refetch}
        ListEmptyComponent={<EmptyGallery />}
        contentContainerStyle={{ padding: 4 }}
        ItemSeparatorComponent={() => <View style={{ height: 4 }} />}
      />
      ```

    - **Merging upload state with API photos:**
      - Get active uploads from useUpload hook
      - For uploads with status 'uploading' or 'failed': create temporary Photo objects (with local file:// URI) and prepend to the photos list
      - For uploads with status 'completed': their photos appear in API response (after React Query refetch)
      - Match upload items to API photos by photoId

    - **Gallery ordering:** Newest first (reverse chronological) -- API returns this order, uploading photos prepended at top

    - **Capture FAB:** Floating action button (circular, bottom-right) with camera icon. On press navigates to Camera screen. Use absolute positioning, elevated shadow.

    - **Column width:** Calculate based on screen width: `(screenWidth - padding * 3) / 2` for 2-column layout with gap

    - **Pull-to-refresh:** FlashList's onRefresh prop triggers `refetch()` from useGallery

    **Step 6: Implement PhotoDetailScreen**
    Create `src/screens/Gallery/PhotoDetailScreen.tsx`:

    - Receives `photoId` from navigation params
    - Fetches photo details or uses cached data from React Query
    - Full-screen photo display with black background
    - **Pinch-to-zoom:** Use react-native-gesture-handler Pinch gesture with Reanimated to scale the image:
      ```typescript
      const scale = useSharedValue(1);
      const pinchGesture = Gesture.Pinch()
        .onUpdate((e) => {
          scale.value = Math.max(1, Math.min(e.scale, 5)); // 1x to 5x zoom
        })
        .onEnd(() => {
          // Animate back to 1x if below threshold
          if (scale.value < 1.1) {
            scale.value = withSpring(1);
          }
        });
      ```
    - Header with back button (top-left) and delete button (top-right, trash icon)
    - Delete confirmation: Alert.alert with "Delete Photo?" confirmation, on confirm call DELETE /api/v1/photos/{id}, invalidate photos cache, navigate back
    - Safe area handling for notches

    **Step 7: Update navigation**
    - Add PhotoDetailScreen to MainStack in RootNavigator.tsx
    - Update navigation types for PhotoDetail params: `{ photoId: string }`
    - Ensure all screen transitions work: Gallery -> Camera -> PhotoReview -> Gallery, Gallery -> PhotoDetail -> Gallery

    **IMPORTANT NOTES:**
    - **No date labels or status badges on thumbnails** (CONTEXT decision: "Photos only, clean, minimal")
    - **Masonry layout:** If FlashList's built-in masonry (`masonry` prop) is stable, use it. If not available or buggy in the installed version, simulate masonry with 2-column FlashList where each item has a calculated height based on aspect ratio. The result looks masonry-like even without true masonry rendering.
    - **FastImage caching:** Set `cache: FastImage.cacheControl.immutable` for photos (they don't change after upload). This avoids re-downloading.
    - **Memory management:** Use FlashList's recycling (estimatedItemSize is critical). Call `FastImage.clearMemoryCache()` if memory warnings occur.
    - **Presigned URL expiry:** Backend presigned GET URLs expire in 1 hour. React Query's staleTime of 1 minute ensures fresh URLs before expiry. If a URL expires mid-session, the refetch will get new URLs.
    - **Upload progress on thumbnails:** The progress bar is an overlay ON the thumbnail. For uploading photos, the thumbnail shows the local file:// URI (from camera capture). After upload completes and cache refreshes, the thumbnail switches to the S3 presigned URL.
  </action>
  <verify>
    1. `cd mobile && npx tsc --noEmit` passes TypeScript compilation
    2. All gallery component files exist: `ls src/components/Gallery/ src/screens/Gallery/`
    3. GalleryScreen uses FlashList with 2 columns and PhotoThumbnail items
    4. PhotoThumbnail uses FastImage with proper caching
    5. UploadProgressOverlay shows progress bar and error state
    6. PhotoDetailScreen renders full-screen image with pinch-to-zoom
    7. EmptyGallery shown when no photos exist
    8. Navigation: Gallery <-> Camera, Gallery <-> PhotoDetail all work
    9. useGallery hook fetches paginated photos with infinite scroll
  </verify>
  <done>
    - Masonry-style gallery with 2-column FlashList and variable-height thumbnails
    - Photos ordered newest first (reverse chronological)
    - FastImage provides efficient caching and memory management
    - Upload progress shown as progress bar overlay on uploading thumbnails
    - Failed uploads show error state with tap-to-retry on thumbnail
    - Empty gallery shows prompt with "Start Capturing" button
    - Full-screen photo detail with pinch-to-zoom (1x-5x)
    - Photo deletion from detail view with confirmation
    - Infinite scroll pagination for large galleries
    - Pull-to-refresh support
    - Capture FAB on gallery navigates to camera
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 2 flow on device</name>
  <what-built>
    Complete iris photo capture, upload, and gallery flow across Plans 01-03:
    1. React Native app with auth integration (Phase 1 backend)
    2. Onboarding: Welcome -> Pre-permission -> Biometric consent info -> Auth
    3. Camera: Full-screen viewfinder with iris guide, flash/switch/zoom controls
    4. Capture: Take photo -> Review (Retake/Accept) -> Upload with progress
    5. Gallery: Masonry layout, upload progress on thumbnails, photo detail with zoom
    6. Biometric consent gate before first camera access
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    - Backend running: `cd backend && docker compose up -d`
    - Register a test user via API or mobile app

    **Test on iOS device (iPhone 12+):**
    1. Build and run: `cd mobile && npx react-native run-ios --device`
    2. First launch: see Welcome screen -> tap "Start capturing"
    3. Pre-permission screen appears -> tap "Continue" -> iOS camera permission dialog appears
    4. Grant camera permission -> see biometric consent info screen -> tap "I understand, continue"
    5. Login/Register screen -> create account or log in
    6. Gallery screen appears (empty state with "Start Capturing" prompt)
    7. Tap capture button (FAB) -> camera opens
    8. Biometric consent flow appears (first camera access) -> grant consent
    9. Camera shows: full-screen viewfinder with circular iris guide overlay
    10. Verify controls: flash toggle, front/back camera switch, pinch-to-zoom
    11. See hint text: "Hold phone 10-15cm from eye, ensure good lighting"
    12. Frame iris and tap shutter -> review screen shows captured photo
    13. Tap "Retake" -> returns to camera (verify this works)
    14. Capture again -> tap "Accept" -> navigates to gallery
    15. See photo thumbnail with progress bar overlay during upload
    16. After upload completes, progress bar disappears, photo shows normally
    17. Tap photo -> full-screen detail view with pinch-to-zoom
    18. Capture 3-5 more photos -> verify gallery shows masonry layout, newest first
    19. Pull down to refresh gallery -> photos reload

    **Test on Android device (12MP+ camera):**
    20. Build and run: `cd mobile && npx react-native run-android`
    21. Repeat steps 2-19 on Android device
    22. Verify camera permission flow works on Android (runtime permission)

    **Error scenarios to test:**
    23. Kill backend during upload -> verify retry happens (progress resets) -> start backend -> upload completes
    24. Deny camera permission -> verify "Open Settings" screen with fallback
    25. Test with slow network (if possible) -> verify progress bar is accurate

    **Visual quality checks:**
    26. Iris guide overlay is visible and centered on camera viewfinder
    27. Gallery thumbnails have consistent spacing and rounded corners
    28. Upload progress bar is visible and updates smoothly
    29. Photo detail pinch-to-zoom is smooth (60fps)
    30. App handles notch/safe area on both iOS and Android

    **Expected results:**
    - All 4 Phase 2 success criteria met:
      1. User captures iris photo with basic camera controls (flash, switch, zoom) on target devices
      2. Photo uploads to cloud storage with visible progress indicator (progress bar on thumbnail)
      3. User views gallery of all captured iris photos (masonry layout, newest first)
      4. Camera permission dialog clearly states purpose (pre-permission screen before system dialog)
  </how-to-verify>
  <resume-signal>Type "approved" if Phase 2 flow works correctly on both iOS and Android. Describe any issues found for fixing.</resume-signal>
</task>

</tasks>

<verification>
1. Gallery displays masonry photo grid with 2 columns
2. Upload progress visible on thumbnails during active uploads
3. Failed uploads show error with retry capability
4. Photo detail shows full-screen image with pinch-to-zoom
5. Empty gallery prompts user to capture first photo
6. Navigation flows correctly: Gallery -> Camera -> PhotoReview -> Gallery -> PhotoDetail
7. Complete Phase 2 flow works on real iOS and Android devices
8. TypeScript compiles without errors
</verification>

<success_criteria>
- Masonry gallery displays all user photos, newest first, with efficient FastImage caching
- Upload progress bar visible on thumbnails during upload
- Failed uploads show error state with tap-to-retry
- Full-screen photo detail with pinch-to-zoom works smoothly
- Empty gallery shows capture prompt
- Complete Phase 2 flow verified on iPhone 12+ and Android 12MP+ device
- All 4 Phase 2 success criteria pass on real devices
</success_criteria>

<output>
After completion, create `.planning/phases/02-camera-capture-and-image-upload/02-03-SUMMARY.md`
</output>
